<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Pulse ‚Äì Campus Events</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%237c3aed;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Ctext x='50' y='60' font-family='Arial, sans-serif' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3EP%3C/text%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%237c3aed;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Ctext x='50' y='60' font-family='Arial, sans-serif' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3EP%3C/text%3E%3C/svg%3E">
<style>
  :root {
    color-scheme: dark; --bg: #121212; --surface: #1a1a1a; --border: #333333;
    --text-primary: #f5f5f5; --text-secondary: #a1a1aa;
    --primary-gradient: linear-gradient(90deg, #8A2BE2, #4F46E5);
    --primary-accent: #7c3aed; --green-accent: #10b981; --red-accent: #ef4444;
    --nav-bg: #1e293b; --nav-active: #2563eb;
  }
  * { box-sizing: border-box; }
  body { margin: 0; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--text-primary); display: flex; align-items: center; justify-content: center; min-height: 100vh; }
  .phone { width: 380px; height: 760px; background: #000; border-radius: 20px; border: 1px solid #222; overflow: hidden; display: flex; flex-direction: column; position: relative; }
  header { height: 56px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 10; background: #000; }
  header .brand { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
  header .brand::before { content: ''; display: block; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-accent); }
  #userInfo span { font-weight: bold; }
  #userInfo button { background: none; border: none; color: var(--red-accent); font-weight: bold; cursor: pointer; padding: 4px 8px; margin-left: 8px; border-radius: 6px; }
  #userInfo button:hover { background: rgba(239, 68, 68, 0.2); }
  .tabs { height: 60px; display: flex; flex-shrink: 0; background-color: var(--nav-bg); padding: 5px; gap: 5px; border-top: 1px solid var(--border); }
  .tab { flex: 1; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-secondary); font-weight: 600; letter-spacing: 0.5px; border-radius: 10px; transition: background-color 0.2s ease, color 0.2s ease; }
  .tab:hover { color: var(--text-primary); }
  .tab.active { background-color: var(--nav-active); color: var(--text-primary); font-weight: bold; }
  .content { flex: 1; overflow-y: auto; padding: 24px; display: none; }
  .content h2 { font-size: 1.5rem; margin-top: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px;}
  .content h3, .content h4 { font-size: 1.2rem; }
  .content p.muted { color: var(--text-secondary); margin-top: 0; margin-bottom: 40px; }
  #screen-auth, #screen-login { display: flex; flex-direction: column; justify-content: center; text-align: center; }
  .password-wrapper { position: relative; display: flex; align-items: center; }
  .password-wrapper input { padding-right: 45px; }
  .password-toggle { position: absolute; right: 15px; cursor: pointer; user-select: none; color: var(--text-secondary); width: 24px; height: 24px; }
  .password-toggle .eye-open-path { display: block; } .password-toggle .eye-closed-path { display: none; }
  input, select { width: 100%; background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; margin-bottom: 16px; font-size: 1rem; }
  input::placeholder { color: var(--text-secondary); }
  input:focus, select:focus { outline: none; border-color: var(--primary-accent); }
  input::-ms-reveal { display: none; }
  .btn { border: none; padding: 14px 20px; border-radius: 999px; font-size: 1rem; font-weight: bold; color: var(--text-primary); cursor: pointer; display: block; width: 100%; margin: 8px 0; text-align: center; background: var(--surface); border: 1px solid var(--border); }
  .btn.primary { background: var(--primary-gradient); border: none; }
  .btn.muted { background: none; border: none; color: var(--text-secondary); font-weight: normal; }
  .btn:disabled { opacity: 0.7; cursor: not-allowed; }
  .card { position: relative; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; overflow: hidden; }
  .card-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
  .category-badge { position: absolute; top: 12px; right: 12px; background: var(--primary-accent); color: white; padding: 3px 8px; border-radius: 99px; font-size: 0.7rem; font-weight: bold; }
  .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 20; }
  .modal-content { background: #1f1f1f; border-radius: 12px; padding: 20px; max-height: 80%; overflow: auto; width: 90%; }
  .close { float: right; cursor: pointer; color: var(--text-secondary); }
  .profile-details { display: flex; flex-direction: column; gap: 15px; }
  .detail-item { background: var(--surface); padding: 10px 15px; border-radius: 8px; }
  .detail-item label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
  .id-card { background: #fff; color: #333; border-radius: 15px; padding: 20px; text-align: center; }
  .id-card-header { border-bottom: 2px solid var(--primary-accent); padding-bottom: 10px; margin-bottom: 15px; }
  .id-card-header h3 { margin: 0; color: #000; }
  .id-card-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-accent); margin: 0 auto 15px auto; object-fit: cover; background: #eee; }
  .id-card-details p { margin: 5px 0; font-size: 0.9rem; }
  .notification-ticker { position: absolute; top: 56px; left: 0; width: 100%; background: var(--primary-gradient); color: white; padding: 8px 0; font-size: 0.9rem; white-space: nowrap; overflow: hidden; cursor: pointer; z-index: 5; display: none; }
  .notification-ticker p { margin: 0; display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; }
  @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
  .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .media-item { position: relative; }
  .media-item img, .media-item video { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; cursor: pointer; }
  .media-item .play-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
  .media-item .play-icon { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; border: 2px solid rgba(255,255,255,0.8); }
  .delete-media-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 1px solid white; z-index: 5; }
  .event-media-section, .event-list-section { margin-bottom: 24px; }
  .sub-nav { display: flex; gap: 24px; margin-bottom: 24px; border-bottom: none; }
  .sub-nav-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 16px; font-size: 1rem; cursor: pointer; border-radius: 10px; }
  .sub-nav-btn.active { color: var(--text-primary); border-color: var(--primary-accent); box-shadow: 0 0 0 1px rgba(124,58,237,0.25) inset; font-weight: bold; }
  .section-wrapper { border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 28px; }
  .section-title { margin: 0 0 12px 0; font-weight: bold; color: var(--text-secondary); letter-spacing: .3px; }
  .highlight-border { border-color: var(--primary-accent) !important; box-shadow: 0 0 0 1px rgba(124,58,237,0.25) inset; }
  .kv { display: grid; grid-template-columns: 80px 1fr; gap: 6px 10px; margin: 8px 0; }
  .kv b { color: #93c5fd; }
  .kv .value { color: #e5e7eb; font-weight: 700; }
  .organizer-kv b { color: #fbbf24; }
  .organizer-kv .value { color: #fef3c7; }
  /* Modals are constrained to the .phone container (which is position:relative) */
  #lightbox-modal, #map-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 100; }
  #lightbox-content { max-width: 95%; max-height: 95%; }
  #lightbox-content img, #lightbox-content video { width: 100%; height: auto; max-height: 80vh; margin-top: 10vh; }
  .lightbox-back-arrow, .map-back-arrow { 
    position: absolute; 
    top: 20px; 
    left: 20px; 
    color: white; 
    font-size: 2.5rem; 
    cursor: pointer; 
    text-decoration: none; 
    z-index: 120; 
    background: rgba(0,0,0,0.6); 
    border-radius: 8px; 
    padding: 8px 12px;
    text-shadow: 0 0 4px black;
  }
  .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
  .checkbox-input { width: auto; margin: 0; vertical-align: middle; accent-color: var(--primary-accent); }
  .checkbox-label { color: var(--text-secondary); font-size: 0.95rem; margin: 0; line-height: 1; display: inline-flex; align-items: center; }
  .chat-composer { display: flex; align-items: center; gap: 8px; background: #0f172a; border: 1px solid var(--border); border-radius: 14px; padding: 8px 10px; }
  .chat-input { flex: 1; background: transparent; border: none; color: var(--text-primary); outline: none; font-size: 1rem; }
  .chat-attach, .chat-send { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 6px; border-radius: 8px; }
  .chat-attach:hover, .chat-send:hover { background: rgba(255,255,255,0.06); color: var(--text-primary); }
  #map-container { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: var(--bg); }
  #map-container iframe { width: 100%; height: 100%; border: none; }
  .map-footer { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; z-index: 10; }
  .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
  @property --p{ syntax: '<number>'; inherits: true; initial-value: 0; }
  .loader-circle { width: 100px; height: 100px; --p:0; position: relative; display: flex; align-items: center; justify-content: center; animation: load 2s forwards; }
  .loader-circle::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(var(--primary-accent) calc(var(--p) * 1%), #0000 0); -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 10px), #000 0); mask: radial-gradient(farthest-side, #0000 calc(100% - 10px), #000 0); }
  #loader-percentage { font-size: 1.5rem; font-weight: bold; }
  @keyframes load { from { --p: 0; } to { --p: 100; } }
</style>
</head>
<body>
<div class="phone">
  <header><div class="brand">Pulse</div><div id="userInfo"></div></header>
  <div id="notificationTicker" class="notification-ticker" onclick="showTab('notifications')"><p id="notificationTickerText"></p></div>
  <div id="screen-auth" class="content" style="display:block;">
    <h2 style="font-size: 2rem;">Welcome to Pulse</h2><p class="muted">Please login or signup to continue</p>
    <button class="btn primary" onclick="showLogin()">Login</button><button class="btn" onclick="showSignup()">Signup</button>
  </div>
  <div id="screen-login" class="content"></div><div id="screen-signup" class="content"></div>
  <div id="screen-home" class="content"></div><div id="screen-tickets" class="content"></div>
  <div id="screen-media" class="content"></div><div id="screen-notifications" class="content"></div>
  <div id="screen-profile" class="content"></div><div id="screen-organizer" class="content"></div>
  <div class="tabs" id="tabs" style="display:none"></div>
  <div id="modal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal()">‚úñ</span><div id="modal-body"></div></div></div>
  <div id="lightbox-modal" onclick="closeLightbox()"><a class="lightbox-back-arrow" onclick="closeLightbox(event)">‚Üê</a><div id="lightbox-content"></div></div>
  <div id="map-modal"><a class="map-back-arrow" onclick="closeMap()">‚Üê</a><div id="map-container"></div></div>
</div>

<script>
const API = "http://localhost:8080/api";
const GOOGLE_MAPS_API_KEY = "AIzaSyDG8ImQsL_8g_4fbFPwUB-EBHPlKBw3u20";
let currentUser = null; let userTickets = []; let notificationInterval = null; let eventStateInterval = null; let countdownInterval = null;
let welcomeBannerUntil = 0;
let lastUpcomingCount = -1;
let currentHomeView = 'upcoming'; let currentMediaView = 'upcoming';

// Persistent login functions
function saveUserSession(user) {
    localStorage.setItem('pulse_user', JSON.stringify(user));
}

function loadUserSession() {
    const savedUser = localStorage.getItem('pulse_user');
    if (savedUser) {
        try {
            return JSON.parse(savedUser);
        } catch (error) {
            console.error('Error parsing saved user:', error);
            localStorage.removeItem('pulse_user');
            return null;
        }
    }
    return null;
}

function clearUserSession() {
    localStorage.removeItem('pulse_user');
}

// Auto-login on page load
function checkSavedLogin() {
    const savedUser = loadUserSession();
    if (savedUser) {
        currentUser = savedUser;
        renderTabs();
        render();
        showTab("home");
        renderTickets(true);
        pollNotifications();
        notificationInterval = setInterval(pollNotifications, 5000);
        eventStateInterval = setInterval(checkEventStates, 30000);
        // Start event start notifications checker
        setInterval(checkEventStartNotifications, 60000); // Check every minute
        // Show welcome back banner
        showWelcomeBanner(`üëã Welcome back, ${savedUser.name}!`);
    } else {
        showTab("auth");
    }
}

// ---------- Navigation & Core UI ----------
function showTab(tab) {
    document.querySelectorAll(".content").forEach(c => c.style.display = "none");
    const tabsContainer = document.getElementById("tabs");
    if (["home", "tickets", "media", "organizer", "notifications", "profile"].includes(tab)) {
        tabsContainer.style.display = "flex";
        tabsContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tabName = tab === 'notifications' ? 'üîî' : tab;
        const activeTab = Array.from(tabsContainer.querySelectorAll('.tab')).find(t => t.getAttribute('data-tab') === tabName);
        if (activeTab) activeTab.classList.add('active');
    } else { tabsContainer.style.display = "none"; }
    const screen = document.getElementById("screen-" + tab);
    if (screen) {
        if (tab === 'login' || tab === 'auth') {
            screen.style.display = 'flex';
            document.getElementById('notificationTicker').style.display = 'none';
        } else { screen.style.display = 'block'; }
    }
    if (tab === 'notifications') { document.getElementById('notificationTicker').style.display = 'none'; } else { pollNotifications(); }
    if (tab === "home") renderEvents(); if (tab === "tickets") renderTickets(); if (tab === "media") renderMedia();
    if (tab === "notifications") renderNotifications(); if (tab === "organizer") renderOrganizer(); if (tab === "profile") renderProfile();
    render();
}
function renderTabs() {
    const tabs = document.getElementById("tabs");
    if (!currentUser) return void(tabs.style.display = "none");
    tabs.innerHTML = `
    <div class="tab" data-tab="home" onclick="showTab('home')">Home</div>
    <div class="tab" data-tab="tickets" onclick="showTab('tickets')">Tickets</div>
    <div class="tab" data-tab="media" onclick="showTab('media')">Media</div>
    <div class="tab" data-tab="üîî" onclick="showTab('notifications')">üîî</div>
    ${currentUser.role === "ORGANIZER" ? `<div class="tab" data-tab="organizer" onclick="showTab('organizer')">Organizer</div>` : ""}
    <div class="tab" data-tab="profile" onclick="showTab('profile')">Profile</div>`;
}
function render() {
    const userInfo = document.getElementById("userInfo");
    if (currentUser) {
        const name = currentUser.name.charAt(0).toUpperCase() + currentUser.name.slice(1);
        const role = currentUser.role === 'ORGANIZER' ? 'O' : 'S';
        userInfo.innerHTML = `<span>${name} (${role})</span> <button onclick="logout()">Logout</button>`;
    } else {
        userInfo.innerHTML = "";
    }
}
function logout() { 
    currentUser = null; 
    clearUserSession(); // Clear saved session
    clearInterval(notificationInterval); 
    clearInterval(eventStateInterval); 
    clearInterval(countdownInterval); 
    notificationInterval = null; 
    eventStateInterval = null; 
    countdownInterval = null; 
    userTickets = []; 
    document.getElementById("notificationTicker").style.display = "none"; 
    showTab("auth"); 
    renderTabs(); 
    render(); 
}
function closeModal() { document.getElementById("modal").style.display = "none"; }

// ---------- Chat (Student & Organizer) ----------
function openEventChat(eventId, title, organizerReg){
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div class="chat-container" style="height:75%; display:flex; flex-direction:column; overflow:hidden">
          <h3 style="margin-top:0">üí¨ Chat ‚Äì ${capitalizeWords(title)}</h3>
          <div id="chatThread" style="flex:1; overflow-y:auto; overflow-x:hidden; background: #111; padding:10px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px"></div>
          <div class="chat-composer">
              <input id="chatInput" class="chat-input" placeholder="Message" onkeydown="if(event.key==='Enter'){sendChatMessage(${eventId}, '${organizerReg}')}" />
              <input type="file" id="chatFile" accept="image/*,video/*" style="display:none" onchange="sendChatMedia(${eventId}, '${organizerReg}')">
              <button class="chat-attach" title="Attach" onclick="document.getElementById('chatFile').click()">üìé</button>
              <button class="chat-send" title="Send" onclick="sendChatMessage(${eventId}, '${organizerReg}')">‚û§</button>
          </div>
          <div id="chatMsg" class="muted" style="margin:6px 0;"></div>
          <div style="display:flex; justify-content:flex-end;"><button class="btn" style="width:auto" onclick="closeModal()">Back</button></div>
        </div>
    `;
    document.getElementById('modal').style.display = 'flex';
    loadChatThread(eventId, currentUser.regNumber, organizerReg);
}

async function loadChatThread(eventId, regA, regB){
    try{
        const res = await fetch(`${API}/messages/thread?eventId=${eventId}&regA=${regA}&regB=${regB}`);
        const data = await res.json();
        const thread = document.getElementById('chatThread');
        if(!res.ok || !data.ok){ thread.innerHTML = '<p class="muted">No messages.</p>'; return; }
        if(!data.messages || data.messages.length===0){ thread.innerHTML = '<p class="muted">No messages.</p>'; return; }
        const isOrganizer = currentUser && currentUser.role === 'ORGANIZER';
        thread.innerHTML = data.messages.map(m => {
            const mine = m.fromReg === currentUser.regNumber;
            if(m.type==='media'){
                const label = m.mediaType==='photo' ? 'Image' : 'Video';
                const onClick = m.mediaType==='photo' ? `showLightbox('${m.url}','photo')` : `showLightbox('${m.url}','video')`;
                return `<div style="text-align:${mine?'right':'left'}; margin:6px 0;">
                    <button onclick="${onClick}" style="display:inline-block; padding:8px 10px; border-radius:10px; background:${mine?'#2563eb':'#374151'}; color:white; border:none; cursor:pointer;">${label}</button>
                    <div class="muted" style="font-size:0.75rem;">${new Date(m.time).toLocaleTimeString()}</div>
                </div>`;
            }
            return `<div style="text-align:${mine?'right':'left'}; margin:6px 0;">
                <span style="display:inline-block; padding:8px 10px; border-radius:10px; background:${mine?'#2563eb':'#374151'}; color:white; max-width:80%; word-break:break-word;">${m.text}</span>
                <div class="muted" style="font-size:0.75rem;">${new Date(m.time).toLocaleTimeString()}</div>
            </div>`;
        }).join('');
        thread.scrollTop = thread.scrollHeight;
    }catch(err){
        document.getElementById('chatThread').innerHTML = '<p class="muted">No messages.</p>';
    }
}

async function sendChatMessage(eventId, organizerReg){
    const input = document.getElementById('chatInput');
    const msgBar = document.getElementById('chatMsg');
    const text = (input.value||'').trim();
    if(!text){ msgBar.textContent = 'Type a message'; return; }
    // Optimistic append
    const thread = document.getElementById('chatThread');
    thread.innerHTML += `<div style="text-align:right; margin:6px 0;"><span style="display:inline-block; padding:8px 10px; border-radius:10px; background:#2563eb; color:white; max-width:80%;">${text}</span><div class="muted" style="font-size:0.75rem;">sending‚Ä¶</div></div>`;
    thread.scrollTop = thread.scrollHeight;
    input.value = '';
    try{
        const res = await fetch(API + '/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, fromReg: currentUser.regNumber, toReg: organizerReg, text }) });
        const data = await res.json();
        if(res.ok && data.ok){
            msgBar.textContent = '‚úÖ Message sent';
            setTimeout(()=> msgBar.textContent = '', 1200);
            loadChatThread(eventId, currentUser.regNumber, organizerReg);
        }else{
            msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send');
        }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}

async function sendChatMedia(eventId, organizerReg){
    const fileInput = document.getElementById('chatFile');
    const msgBar = document.getElementById('chatMsg');
    if(!fileInput.files || fileInput.files.length===0){ msgBar.textContent = 'Select an image or video (max 10MB)'; return; }
    const file = fileInput.files[0];
    if(file.size > 10*1024*1024){ msgBar.textContent = '‚ùå File too large (max 10MB)'; return; }
    const thread = document.getElementById('chatThread');
    // Optimistic preview
    if(file.type.startsWith('image/')){
        const url = URL.createObjectURL(file);
        thread.innerHTML += `<div style="text-align:right; margin:6px 0;"><img src="${url}" style="max-width:70%; border-radius:8px;"><div class="muted" style="font-size:0.75rem;">uploading‚Ä¶</div></div>`;
    } else if(file.type.startsWith('video/')){
        const url = URL.createObjectURL(file);
        thread.innerHTML += `<div style="text-align:right; margin:6px 0;"><video src="${url}" controls style="max-width:70%; border-radius:8px;"></video><div class="muted" style="font-size:0.75rem;">uploading‚Ä¶</div></div>`;
    }
    thread.scrollTop = thread.scrollHeight;
    try{
        const form = new FormData();
        form.append('file', file);
        form.append('eventId', String(eventId));
        form.append('fromReg', currentUser.regNumber);
        form.append('toReg', organizerReg);
        const res = await fetch(API + '/messages/media', { method: 'POST', body: form });
        const data = await res.json();
        if(res.ok && data.ok){ msgBar.textContent = '‚úÖ Media sent'; setTimeout(()=> msgBar.textContent='', 1200); loadChatThread(eventId, currentUser.regNumber, organizerReg); }
        else { msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send media'); }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}

// ---------- Home & Media Pages ----------
let currentSearchQuery = '';
let currentDateFilter = 'all';
let currentSortOrder = 'upcoming';

function setHomeView(view) { currentHomeView = view; renderEvents(); }
function setMediaView(view) { currentMediaView = view; renderMedia(); }

function toggleEventSearch() {
    const searchSection = document.getElementById('search-filter-section');
    if (searchSection.style.display === 'none') {
        searchSection.style.display = 'block';
    } else {
        searchSection.style.display = 'none';
    }
}

function applyEventFilters() {
    const searchQuery = document.getElementById('eventSearch').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    const sortOrder = document.getElementById('sortOrder').value;
    
    currentSearchQuery = searchQuery;
    currentDateFilter = dateFilter;
    currentSortOrder = sortOrder;
    
    renderEvents();
}

function clearEventSearch() {
    currentSearchQuery = '';
    const input = document.getElementById('eventSearch');
    if (input) input.value = '';
    const section = document.getElementById('search-filter-section');
    if (section) section.style.display = 'none';
    renderEvents();
}

async function renderEvents() {
    if (countdownInterval) clearInterval(countdownInterval);
    const res = await fetch(API + "/events"); const data = await res.json();
    const c = document.getElementById("screen-home");
    c.innerHTML = `
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn" onclick="toggleEventSearch()">üîç Search</button>
            <button class="btn" onclick="refreshEvents()">üîÑ Refresh</button>
            ${currentSearchQuery ? `<button class="btn" onclick="clearEventSearch()">‚¨Ö Back</button>` : ''}
        </div>
        <div id="search-filter-section" class="search-filter-section" style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
            <h3 style="margin: 0 0 10px 0; color: var(--text-primary);">Search</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input id="eventSearch" type="text" placeholder="Search by title, venue, or category..." 
                       style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);"
                       value="${currentSearchQuery}">
                <select id="dateFilter" 
                        style="padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                    <option value="all" ${currentDateFilter === 'all' ? 'selected' : ''}>All Events</option>
                    <option value="today" ${currentDateFilter === 'today' ? 'selected' : ''}>Today</option>
                    <option value="week" ${currentDateFilter === 'week' ? 'selected' : ''}>This Week</option>
                </select>
                <select id="sortOrder" 
                        style="padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                    <option value="upcoming" ${currentSortOrder === 'upcoming' ? 'selected' : ''}>Upcoming First</option>
                    <option value="past" ${currentSortOrder === 'past' ? 'selected' : ''}>Past First</option>
                </select>
                <button class="btn" onclick="applyEventFilters()">üîç Search</button>
                <button class="btn" onclick="clearEventSearch()">‚¨Ö Back</button>
            </div>
        </div>
        <div class="sub-nav">
            <button class="sub-nav-btn ${currentHomeView === 'upcoming' ? 'active' : ''}" onclick="setHomeView('upcoming')">Upcoming & Live</button>
            <button class="sub-nav-btn ${currentHomeView === 'past' ? 'active' : ''}" onclick="setHomeView('past')">Past</button>
        </div>
        <div id="home-content"></div>`;
    const homeContent = document.getElementById('home-content');
    if (!data.ok || !data.events || data.events.length === 0) { homeContent.innerHTML = `<p class="muted">üìå No events found.</p>`; return; }
    const now = new Date();
    
    // Apply search and date filters
    let filteredEvents = data.events.filter(e => {
        const titleLc = String(e.title || '').toLowerCase();
        const venueLc = String(e.venue || '').toLowerCase();
        const categoryLc = String(e.category || '').toLowerCase();
        const matchesSearch = !currentSearchQuery || 
            titleLc.includes(currentSearchQuery) ||
            venueLc.includes(currentSearchQuery) ||
            categoryLc.includes(currentSearchQuery);
        
        if (!matchesSearch) return false;
        
        const eventDate = new Date(e.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (currentDateFilter === 'today') {
            return eventDate.getTime() === today.getTime();
        } else if (currentDateFilter === 'week') {
            const weekEnd = new Date(today);
            weekEnd.setDate(today.getDate() + 7);
            return eventDate >= today && eventDate <= weekEnd;
        }
        return true; // 'all'
    });
    
    const upcomingEvents = filteredEvents.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) >= now);
    const pastEvents = filteredEvents.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) < now);
    
    // Apply sorting
    if (currentSortOrder === 'upcoming') {
        upcomingEvents.sort((a,b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
        pastEvents.sort((a,b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
    } else {
        pastEvents.sort((a,b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
        upcomingEvents.sort((a,b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
    }
    const sectionEl = document.createElement('div');
    sectionEl.className = 'section-wrapper ' + (currentHomeView === 'past' ? 'highlight-border' : '');
    const sectionTitle = document.createElement('h4');
    sectionTitle.className = 'section-title';
    const resultCount = currentHomeView === 'past' ? pastEvents.length : upcomingEvents.length;
    sectionTitle.textContent = currentHomeView === 'past' ? `Past Events (${resultCount})` : `Upcoming & Live Events (${resultCount})`;
    sectionEl.appendChild(sectionTitle);
    homeContent.appendChild(sectionEl);

    if (currentHomeView === 'upcoming') {
        if (upcomingEvents.length === 0) { sectionEl.innerHTML += `<p class="muted">No upcoming or live events right now.</p>`; }
        else {
            upcomingEvents.forEach(e => {
                const isBooked = userTickets.some(t => t.eventId === e.id);
                const isCreator = currentUser.role === 'ORGANIZER' && e.creatorRegNumber === currentUser.regNumber;
                const isFull = (e.taken || 0) >= (e.capacity || 0);
                const isVolunteer = Array.isArray(e.volunteers) && e.volunteers.some(v => v.regNumber === currentUser.regNumber);
                const div = document.createElement("div"); div.className = "card";
                const startTime = parseEventDateTime(e.date, e.time);
                const statusElementId = `countdown-${e.id}`;
                div.innerHTML = `
                    <div class="category-badge">${e.category}</div>
                    <b style="font-size:1.05rem;color:#93c5fd;">${capitalizeWords(e.title)}</b>
                    <div class="kv">
                        <b>Venue:</b> <span class="value">${capitalizeWords(e.venue)}</span>
                        <b>Date:</b> <span class="value">${e.date}</span>
                        <b>Time:</b> <span class="value">${e.time}</span>
                        <b>Seats:</b> <span class="value">${e.taken}/${e.capacity}</span>
                        <b>Availability:</b> <span class="value" style="color:${isFull ? '#ef4444' : '#10b981'}">${isFull ? 'Venue Full' : 'Available'}</span>
                        <b>Status:</b> <span class="value" id="${statusElementId}" data-start-time="${startTime.toISOString()}"></span>
                    </div>`;
                const chatButton = (isBooked || isVolunteer) ? `<button class="btn" onclick="openEventChat(${e.id}, '${e.title}', '${e.creatorRegNumber}')">üí¨ Chat</button>` : '';
                const volunteerObj = isVolunteer ? (e.volunteers.find(v => v.regNumber === currentUser.regNumber) || {}) : null;
                const volunteerCardBtn = isVolunteer
                    ? `<button class="btn" onclick="openVolunteerIdCard(${e.id})">ü™™ Show Volunteer ID Card</button>`
                    : '';
                const bookButton = isVolunteer
                    ? `<button class="btn" disabled style="border-color: var(--green-accent); color: var(--green-accent);">‚úì Volunteer</button>`
                    : isBooked
                    ? `<button class="btn" disabled style="background: var(--green-accent); border-color: var(--green-accent);">‚úì Booked</button>`
                    : isCreator
                        ? `<button class="btn" disabled>Your Event</button>`
                        : isFull
                            ? `<div style="display:flex; gap:8px; width:100%">
                                   <button class="btn" disabled style="border-color: var(--red-accent); color: var(--red-accent); flex:1;">Venue Full</button>
                                   <button class="btn" style="flex:1;" onclick="joinWaitlist(${e.id})">Join Waitlist</button>
                               </div>`
                            : `<button class="btn primary" onclick="bookTicket(${e.id})">Book Ticket</button>`;
                const mapButton = `<button class="btn" onclick="showMapModal('${e.venue}')">üìç View on Map</button>`;
                div.innerHTML += `<div class="card-buttons">${volunteerCardBtn}${bookButton}${mapButton}</div>`;
                if (chatButton) {
                    const btnRow = document.createElement('div');
                    btnRow.className = 'card-buttons';
                    btnRow.innerHTML = `${chatButton}`;
                    div.appendChild(btnRow);
                }
                sectionEl.appendChild(div);
            });
            startCountdownTimers();
        }
    } else {
        if (pastEvents.length === 0) { sectionEl.innerHTML += `<p class=\"muted\">No past events yet.</p>`; }
        else {
            pastEvents.forEach(e => {
                const div = document.createElement("div"); div.className = "card"; div.style.cursor = 'default';
                div.innerHTML = `
                    <div class="category-badge">${e.category}</div>
                    <b style="font-size:1.05rem;color:#93c5fd;">${capitalizeWords(e.title)}</b>
                    <div class="kv">
                        <b>Venue:</b> <span class="value">${capitalizeWords(e.venue)}</span>
                        <b>Date:</b> <span class="value">${e.date}</span>
                        <b>Time:</b> <span class="value">${e.time}</span>
                        <b>Seats:</b> <span class="value">${e.taken}/${e.capacity}</span>
                    </div>`;
                sectionEl.appendChild(div);
            });
        }
    }
}
async function renderMedia() {
    const res = await fetch(API + "/events"); const data = await res.json();
    const c = document.getElementById("screen-media");
    c.innerHTML = `<h2>Event Media Gallery</h2><div class="sub-nav"><button class="sub-nav-btn ${currentMediaView === 'upcoming' ? 'active' : ''}" onclick="setMediaView('upcoming')">Upcoming & Live</button><button class="sub-nav-btn ${currentMediaView === 'past' ? 'active' : ''}" onclick="setMediaView('past')">Past</button></div><div id="media-content"></div>`;
    const mediaContent = document.getElementById('media-content');
    if (!data.ok) { mediaContent.innerHTML = `<p class="muted">Could not load media.</p>`; return; }
    const eventsWithMedia = data.events.filter(e => e.media && e.media.length > 0);
    if (eventsWithMedia.length === 0) { mediaContent.innerHTML = `<p class="muted">üñºÔ∏è No media has been uploaded for any event yet.</p>`; return; }
    const now = new Date();
    const upcomingMediaEvents = eventsWithMedia.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) >= now).sort((a,b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
    const pastMediaEvents = eventsWithMedia.filter(e => new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000) < now).sort((a,b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
    const renderMediaSection = (events) => {
        if (events.length === 0) return `<p class="muted">No media in this section.</p>`;
        let sectionHtml = '';
        events.forEach(event => {
            sectionHtml += `<div class="event-media-section"><h4>${event.title} - ${event.date}</h4><div class="media-grid">`;
            event.media.forEach(m => {
                if (m.type === "photo") sectionHtml += `<div class=\"media-item\"><img src=\"http://localhost:5000${m.url}\" onclick=\"showLightbox('${m.url}', 'photo')\"></div>`;
                if (m.type === "video") sectionHtml += `<div class=\"media-item\" onclick=\"showLightbox('${m.url}', 'video')\"><video src=\"http://localhost:5000${m.url}\" preload=\"metadata\"></video><div class=\"play-overlay\"><div class=\"play-icon\">‚ñ∂</div></div></div>`;
            });
            sectionHtml += `</div></div>`;
        });
        return sectionHtml;
    };
    mediaContent.innerHTML = currentMediaView === 'upcoming' ? renderMediaSection(upcomingMediaEvents) : renderMediaSection(pastMediaEvents);
}

// ---------- Auth ----------
function showAuth() { showTab('auth'); }
function showLogin() {
    const s = document.getElementById("screen-login");
    s.innerHTML = `
    <div>
        <h2 style="font-size: 2rem;">Login</h2>
        <input id="loginReg" placeholder="Registration Number">
        <div class="password-wrapper">
             <input id="loginPass" type="password" placeholder="Password">
             <span class="password-toggle" onclick="togglePasswordVisibility('loginPass')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                    <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
             </span>
        </div>
        <div class="checkbox-row">
            <input type="checkbox" id="rememberMe" checked class="checkbox-input">
            <label for="rememberMe" class="checkbox-label">Keep me logged in</label>
        </div>
        <button class="btn primary" onclick="doLogin()">Login</button>
        <button class="btn" onclick="showSignup()">Sign Up</button>
        <button class="btn muted" onclick="showForgotPassword()">Forgot Password?</button>
        <div id="loginMsg" class="muted"></div>
    </div>`;
    showTab('login');
}
function showSignup() {
    const s = document.getElementById("screen-signup");
    s.innerHTML = `
    <h2 style="font-size: 2rem;">Sign Up</h2>
    <input id="name" placeholder="Name"><input id="surname" placeholder="Surname"><input id="age" placeholder="Age" type="number"><select id="gender"><option>Male</option><option>Female</option><option>Other</option></select>
    <input id="email" placeholder="Email" type="email"><input id="phone" placeholder="Phone (10 digits)"><input id="regNumber" placeholder="Registration Number">
    <div class="password-wrapper">
        <input id="password" type="password" placeholder="Password">
        <span class="password-toggle" onclick="togglePasswordVisibility('password')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        </span>
    </div>
    <select id="role"><option>STUDENT</option><option>ORGANIZER</option></select>
    <button class="btn primary" onclick="doSignup()">Sign Up</button>
    <button class="btn" onclick="showLogin()">Cancel</button>
    <div id="signupMsg" class="muted"></div>`;
    showTab('signup');
}
function showForgotPassword() {
    const s = document.getElementById("screen-login");
    s.innerHTML = `
    <div>
        <h2 style="font-size: 2rem;">Forgot Password</h2>
        <input id="resetReg" placeholder="Registration Number">
        <select id="resetRole"><option>STUDENT</option><option>ORGANIZER</option></select>
        <div class="password-wrapper">
            <input id="newPassword" type="password" placeholder="New Password">
            <span class="password-toggle" onclick="togglePasswordVisibility('newPassword')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                    <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </span>
        </div>
        <div class="password-wrapper">
            <input id="confirmNewPassword" type="password" placeholder="Confirm New Password">
            <span class="password-toggle" onclick="togglePasswordVisibility('confirmNewPassword')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path class="eye-open-path" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle class="eye-open-path" cx="12" cy="12" r="3"></circle>
                    <path class="eye-closed-path" d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line class="eye-closed-path" x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </span>
        </div>
        <button class="btn primary" onclick="doResetPassword()">Reset Password</button>
        <button class="btn" onclick="showLogin()">Cancel</button>
        <div id="resetMsg" class="muted"></div>
    </div>`;
    showTab('login');
}
async function doLogin() {
    const regNumber = document.getElementById("loginReg").value; const password = document.getElementById("loginPass").value;
    const msg = document.getElementById("loginMsg"); msg.textContent = "‚è≥ Logging in...";
    try {
        const res = await fetch(API + "/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ regNumber, password }) });
        const data = await res.json();
        if (res.ok && data.ok) {
            msg.textContent = "‚úÖ Login successful! Redirecting...";
            setTimeout(async () => {
                currentUser = data.user;
                
                // Check if "Remember Me" is checked
                const rememberMe = document.getElementById("rememberMe");
                if (rememberMe && rememberMe.checked) {
                    saveUserSession(currentUser); // Save user session
                }
                
                await renderTickets(true); 
                pollNotifications();
                notificationInterval = setInterval(pollNotifications, 5000);
                eventStateInterval = setInterval(checkEventStates, 30000);
                // Start event start notifications checker
                setInterval(checkEventStartNotifications, 60000); // Check every minute
                renderTabs(); 
                showTab("home");
                
                // Welcome back banner
                showWelcomeBanner(`üëã Welcome back, ${data.user.name}!`);
            }, 1000);
        } else { msg.textContent = "‚ùå " + (data.error || "Login failed"); }
    } catch { msg.textContent = "‚ùå Network error"; }
}
async function doSignup() {
    const user = { name: capitalizeWords(document.getElementById("name").value), surname: capitalizeWords(document.getElementById("surname").value), age: document.getElementById("age").value, gender: document.getElementById("gender").value, email: document.getElementById("email").value, phone: document.getElementById("phone").value, regNumber: document.getElementById("regNumber").value, password: document.getElementById("password").value, role: document.getElementById("role").value };
    const msg = document.getElementById("signupMsg"); msg.textContent = "‚è≥ Signing up...";
    try {
        const res = await fetch(API + "/signup", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(user) });
        const data = await res.json();
        if (res.ok && data.ok) {
            msg.textContent = "‚úÖ Account created! Signing you in...";
            setTimeout(async () => {
                // Auto-login the newly created user
                try {
                    const loginRes = await fetch(API + "/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ regNumber: user.regNumber, password: user.password })
                    });
                    const loginData = await loginRes.json();
                    
                    if (loginRes.ok && loginData.ok) {
                        currentUser = loginData.user;
                        saveUserSession(currentUser); // Auto-save session for new users
                        await renderTickets(true);
                        pollNotifications();
                        notificationInterval = setInterval(pollNotifications, 5000);
                        eventStateInterval = setInterval(checkEventStates, 30000);
                        // Start event start notifications checker
                        setInterval(checkEventStartNotifications, 60000); // Check every minute
                        renderTabs();
                        showTab("home");
                        // Welcome banner for new signup
                        showWelcomeBanner(`üéâ Welcome, ${user.name}!`);
                    } else {
                        // Fallback to login screen if auto-login fails
                        showLogin();
                    }
                } catch (error) {
                    // Fallback to login screen if auto-login fails
                    showLogin();
                }
            }, 2000);
        } else { msg.textContent = "‚ùå " + (data.error || "Signup failed"); }
    } catch { msg.textContent = "‚ùå Network error"; }
}
async function doResetPassword() { const e = document.getElementById("resetReg").value, t = document.getElementById("resetRole").value, n = document.getElementById("newPassword").value, c = document.getElementById("confirmNewPassword").value, a = document.getElementById("resetMsg"); if(n!==c){ a.textContent = "‚ùå Passwords do not match"; return;} if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/.test(n)) return void (a.textContent = "‚ùå Password must contain uppercase, lowercase, number and be at least 6 characters long"); a.textContent = "‚è≥ Resetting password..."; try { const i = await fetch(API + "/reset-password", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ regNumber: e, role: t, newPassword: n }) }), o = await i.json(); i.ok && o.ok ? (a.textContent = "‚úÖ Password changed successfully! Redirecting...", setTimeout(showLogin, 1000)) : a.textContent = "‚ùå " + (o.error || "Password reset failed.") } catch { a.textContent = "‚ùå Network error" } }
function togglePasswordVisibility(e) { const t = document.getElementById(e), n = t.nextElementSibling, a = n.querySelectorAll(".eye-open-path"), i = n.querySelectorAll(".eye-closed-path"); "password" === t.type ? (t.type = "text", a.forEach(e => e.style.display = "none"), i.forEach(e => e.style.display = "block")) : (t.type = "password", a.forEach(e => e.style.display = "block"), i.forEach(e => e.style.display = "none")) }

// ---------- Tickets ----------
async function bookTicket(e){const t=await fetch(API+"/tickets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:e,regNumber:currentUser.regNumber})}),n=await t.json();t.ok&&n.ok?(alert("üéüÔ∏è Ticket booked!"),await renderTickets(!0),renderEvents()):alert("‚ùå "+(n.error||"Booking failed"))}
async function renderTickets(e=!1){
    const t=await fetch(API+"/events"),n=await t.json();
    const a=await fetch(API+"/tickets/"+currentUser.regNumber),i=await a.json();
    if(!i.ok||!n.ok)return void(userTickets=[]);
    userTickets=i.tickets||[];
    if(e)return;
    const o=document.getElementById("screen-tickets");
    o.innerHTML=`<button class="btn" onclick="refreshTickets()">üîÑ Refresh</button>`;
    if(0===userTickets.length){ o.innerHTML+=`<p class="muted">üéüÔ∏è No ticket booking history yet.</p>`; return; }
    
    // Sort tickets: upcoming booked, upcoming waiting, past booked, past waiting
    const now = new Date();
    const sortedTickets = userTickets.sort((a, b) => {
        const eventA = n.events.find(e => e.id === a.eventId);
        const eventB = n.events.find(e => e.id === b.eventId);
        if (!eventA || !eventB) return 0;
        
        const endTimeA = new Date(parseEventDateTime(eventA.date, eventA.time).getTime() + (eventA.duration || 0) * 60000);
        const endTimeB = new Date(parseEventDateTime(eventB.date, eventB.time).getTime() + (eventB.duration || 0) * 60000);
        
        const isUpcomingA = endTimeA >= now;
        const isUpcomingB = endTimeB >= now;
        
        // First sort by upcoming vs past
        if (isUpcomingA !== isUpcomingB) {
            return isUpcomingA ? -1 : 1; // upcoming first
        }
        
        // Within same time category, sort by booked vs waiting
        if (a.waiting !== b.waiting) {
            return a.waiting ? 1 : -1; // booked first
        }
        
        // Within same status, sort by date
        return parseEventDateTime(eventA.date, eventA.time) - parseEventDateTime(eventB.date, eventB.time);
    });
    
    sortedTickets.forEach(e=>{
        const t=document.createElement("div"); t.className="card";
        const a=n.events.find(t=>t.id===e.eventId);
        const isWaiting = !!e.waiting;
        let actionHtml = "";
        if(a){
            const evStart = parseEventDateTime(a.date,a.time);
            if(!isWaiting && new Date < evStart){
                actionHtml = `<button class="btn" style="border-color: var(--red-accent); color: var(--red-accent);" onclick="cancelTicket(${a.id}, '${a.title}')">Cancel Ticket</button>`;
            }
            if(isWaiting){
                actionHtml = `<button class="btn" style="border-color: var(--red-accent); color: var(--red-accent);" onclick="cancelWait(${a.id})">Leave Waitlist</button>`;
            }
        }
        const badge = a ? a.category : "N/A";
        const idLine = isWaiting ? `Wait ID: ${e.ticketId} ‚Ä¢ Position: ${e.position}` : `Seat: ${e.seat}<br>ID: ${e.ticketId}`;
        const title = isWaiting ? `‚è≥ Waiting ‚Ä¢ ${e.eventTitle}` : e.eventTitle;
        t.innerHTML=`<div class="category-badge">${badge}</div><b>${title}</b><br>üìç ${e.venue}<br>üìÖ ${e.date} üïí ${e.time}<br>${idLine}${actionHtml}`;
        t.onclick=s=>{"BUTTON"!==s.target.tagName&&showTicketDetail(e)};
        o.appendChild(t)
    })
}

async function cancelWait(eventId){
    if(!confirm('Leave the waitlist for this event?')) return;
    const res = await fetch(API+"/waitlist", { method:"DELETE", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ eventId, regNumber: currentUser.regNumber })});
    const data = await res.json();
    if(res.ok && data.ok){ alert('Removed from waitlist.'); await renderTickets(true); renderTickets(); renderEvents(); setTimeout(renderEvents, 500); }
    else { alert('Error: '+(data.error||'Failed to leave waitlist.')); }
}
async function cancelTicket(e,t){if(confirm(`Are you sure you want to cancel your ticket for "${t}"?`)){const t=await fetch(API+"/tickets",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId:e,regNumber:currentUser.regNumber})}),n=await t.json();t.ok&&n.ok?(alert("Ticket cancelled successfully."),await renderTickets(!0),renderTickets(),renderEvents()):alert("Error: "+(n.error||"Failed to cancel ticket."))}}

// ---------- Organizer Functions ----------
function createEventScreen() {
    const e = document.getElementById("screen-organizer"); const t = new Date().toISOString().split("T")[0];
    const categories = ["Education", "Soft Skills", "Sports", "Cultural", "Technology", "Science", "Music", "Art & Craft", "Gaming", "Hackathon", "Workshop", "Seminar", "Conference", "Fest", "Charity", "Water Activities", "Other"];
    let categoryOptions = categories.map(c => `<option>${c}</option>`).join('');
    const venues = ["LH-C", "LH-D", "LH-A", "LHB (MB)", "SJA", "MAIN BUILDING", "SEMINAR HALL A (MB)", "SEMINAR HALL B (MB)", "SEMINAR HALL C (MB)", "OPEN THEATER", "NEW SPORTS COMPLEX", "MAIN GROUND", "NITK BEACH", "CRF", "GYM"];
    let venueOptions = venues.map(v => `<option>${v}</option>`).join('');
    e.innerHTML = `<h2>Create Event</h2>
    <input id="evTitle" placeholder="Event Title">
    <select id="evCategory"><option value="" disabled selected>Select a Category</option>${categoryOptions}</select>
    <select id="evVenue"><option value="" disabled selected>Select a Venue</option>${venueOptions}</select>
    <input id="evDate" type="date" min="${t}" onchange="updateMinTime('evDate', 'evTime')"><input id="evTime" type="time">
    <input id="evCap" type="number" placeholder="Seat Capacity"><input id="evDuration" type="number" placeholder="Duration (in minutes)">
    <div class="card" style="margin-top:10px;">
        <div class="kv organizer-kv">
            <b>Volunteers:</b>
            <span class="value">
                <input id="evVolCount" type="number" min="0" value="0" style="width:80px" oninput="renderVolunteerInputs()"> number of volunteers
            </span>
        </div>
        <div id="evVolunteerInputs" style="margin-top:8px;"></div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn primary" onclick="doCreateEvent()" style="flex: 1;">Create Event</button>
        <button class="btn" onclick="renderOrganizer()" style="flex: 1;">Cancel</button>
    </div>
    <div id="evMsg" class="muted"></div>`;
    updateMinTime("evDate", "evTime");
}
function renderVolunteerInputs(){
    const container = document.getElementById('evVolunteerInputs');
    if(!container) return;
    const n = Math.max(0, Number(document.getElementById('evVolCount').value||0));
    let html = '';
    for(let i=1;i<=n;i++){
        html += `<div style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px;">
                    <input id="evVolReg${i}" placeholder="Volunteer #${i} RegNumber">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn" onclick="verifyVolunteerReg('evVolReg${i}', 'evVolStatus${i}', 'evVolRoleRow${i}', currentUser.regNumber)">Verify</button>
                        <button class="btn" onclick="clearVolunteerEntry(${i})">Clear</button>
                        <span id="evVolStatus${i}" class="muted"></span>
                    </div>
                    <div id="evVolRoleRow${i}" style="display:none; gap:8px; align-items:center;">
                        <select id="evVolRole${i}" style="flex:1" onchange="syncVolunteerRoles()">
                            <option value="" disabled selected>Select Role</option>
                        </select>
                    </div>
                 </div>`;
    }
    container.innerHTML = html || `<span class="muted">No volunteers. Set count above to add.</span>`;
    populateVolunteerRoleOptions();
}
const VOL_ROLES = ["Registration Desk","Stage Management","Guest Reception","Crowd Control","Logistics","Media Support"];
function getSelectedRolesInCreate(){
    const count = Number(document.getElementById('evVolCount')?.value||0);
    const roles = [];
    for(let i=1;i<=count;i++){
        const val = document.getElementById(`evVolRole${i}`)?.value;
        if(val) roles.push(val);
    }
    return roles;
}
function populateVolunteerRoleOptions(){
    const count = Number(document.getElementById('evVolCount')?.value||0);
    const chosen = new Set(getSelectedRolesInCreate());
    for(let i=1;i<=count;i++){
        const sel = document.getElementById(`evVolRole${i}`);
        if(!sel) continue;
        const current = sel.value;
        sel.innerHTML = `<option value="" disabled ${current?"":"selected"}>Select Role</option>` + VOL_ROLES
            .filter(r => r === current || !chosen.has(r))
            .map(r => `<option ${r===current?"selected":""}>${r}</option>`)
            .join('');
    }
}
function syncVolunteerRoles(){ populateVolunteerRoleOptions(); }
async function verifyVolunteerReg(inputId, statusId, roleRowId, organizerReg){
    const inp = document.getElementById(inputId); const st = document.getElementById(statusId); const roleRow = roleRowId ? document.getElementById(roleRowId) : null;
    if(!inp || !st) return;
    const reg = String(inp.value||'').trim();
    // Prevent the organizer of this event from being verified as volunteer (but allow other organizers)
    if (organizerReg && reg === organizerReg) {
        st.textContent = 'Organizer cannot be a volunteer'; st.style.color = '#ef4444'; if(roleRow) roleRow.style.display = 'none'; return;
    }
    if(!reg){ st.textContent = 'Enter reg number'; st.style.color = '#fca5a5'; return; }
    st.textContent = 'Verifying...'; st.style.color = '';
    try{
        const r = await fetch(`${API}/users/${reg}`);
        const d = await r.json();
        if(r.ok && d.ok){ st.textContent = '‚úì Verified'; st.style.color = '#10b981'; if(roleRow) roleRow.style.display = 'flex'; }
        else { st.textContent = 'User not exists'; st.style.color = '#ef4444'; if(roleRow) roleRow.style.display = 'none'; }
    }catch{ st.textContent = 'Network error'; st.style.color = '#ef4444'; }
}
function clearVolunteerEntry(i){
    const reg = document.getElementById(`evVolReg${i}`);
    const st = document.getElementById(`evVolStatus${i}`);
    const roleRow = document.getElementById(`evVolRoleRow${i}`);
    const role = document.getElementById(`evVolRole${i}`);
    if(reg) reg.value = '';
    if(st){ st.textContent = ''; st.style.color = ''; }
    if(roleRow) roleRow.style.display = 'none';
    if(role) role.value = '';
    populateVolunteerRoleOptions();
}
async function doCreateEvent() {
    const e = {
        title: capitalizeWords(document.getElementById("evTitle").value), venue: document.getElementById("evVenue").value, date: document.getElementById("evDate").value, time: document.getElementById("evTime").value,
        capacity: document.getElementById("evCap").value, duration: document.getElementById("evDuration").value, category: document.getElementById("evCategory").value, creatorRegNumber: currentUser.regNumber
    };
    if (!e.title || !e.venue || !e.date || !e.time || !e.capacity || !e.duration || !e.category) return void alert("Please fill all event fields.");
    if (new Date(`${e.date}T${e.time}`) < new Date) return void alert("Event date and time must be in the future.");
    // Collect volunteers
    const countEl = document.getElementById('evVolCount');
    const vCount = countEl ? Number(countEl.value||0) : 0;
    const volunteers = [];
    for(let i=1;i<=vCount;i++){
        const reg = String(document.getElementById(`evVolReg${i}`)?.value||'').trim();
        if(!reg){ return void alert(`Please enter reg number for volunteer #${i}`); }
        const role = String(document.getElementById(`evVolRole${i}`)?.value||'').trim();
        if(!role){ return void alert(`Please select a role for volunteer #${i}`); }
        // verify exists
        try{
            const r = await fetch(`${API}/users/${reg}`);
            const d = await r.json();
            if(!(r.ok && d.ok)) return void alert(`Volunteer not found: ${reg}`);
            volunteers.push({ regNumber: reg, role });
        }catch{ return void alert(`Failed to verify volunteer: ${reg}`); }
    }
    if(volunteers.length>0){ e.volunteers = volunteers; }
    
    const modal = document.getElementById("modal");
    const modalBody = document.getElementById("modal-body");
    modalBody.innerHTML = `<div class="loader-container"><div class="loader-circle"></div><p id="loader-percentage">0%</p><p>Checking for slot...</p></div>`;
    modal.style.display = "flex";
    
    let progress = 0;
    const loaderPercentage = modalBody.querySelector("#loader-percentage");
    const interval = setInterval(() => {
        progress += 5;
        if(progress > 100) progress = 100;
        loaderPercentage.textContent = `${progress}%`;
        loaderCircle.style.setProperty('--p', progress);
        if (progress >= 100) clearInterval(interval);
    }, 100);

    setTimeout(async () => {
        const t = await fetch(API + "/events", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) });
        closeModal();
        if (t.ok) {
            alert("‚úÖ Event created!");
            renderOrganizer();
            renderEvents();
        } else {
            const data = await t.json();
            alert("Error: " + (data.error || "Failed to create event."));
        }
    }, 2000);
}
async function editEvent(e) {
    const t = await fetch(API + "/events"), n = await t.json(), a = n.events.find(t => t.id === e);
    const i = new Date().toISOString().split("T")[0];
    const venues = ["LH-C", "LH-D", "LH-A", "LHB (MB)", "SJA", "MAIN BUILDING", "SEMINAR HALL A (MB)", "SEMINAR HALL B (MB)", "SEMINAR HALL C (MB)", "OPEN THEATER", "NEW SPORTS COMPLEX", "MAIN GROUND", "NITK BEACH", "CRF", "GYM"];
    let venueOptions = venues.map(v => `<option ${a.venue === v ? 'selected' : ''}>${v}</option>`).join('');
    const categories = ["Education", "Soft Skills", "Sports", "Cultural", "Technology", "Science", "Music", "Art & Craft", "Gaming", "Hackathon", "Workshop", "Seminar", "Conference", "Fest", "Charity", "Water Activities", "Other"];
    let categoryOptions = categories.map(c => `<option ${a.category === c ? 'selected' : ''}>${c}</option>`).join('');
    const o = document.getElementById("modal"), l = document.getElementById("modal-body");
    l.innerHTML = `<h3>Edit Event</h3>
        <input id="editTitle" value="${a.title}">
        <select id="editCategory">${categoryOptions}</select>
        <select id="editVenue">${venueOptions}</select>
        <input id="editDate" type="date" value="${a.date}" min="${i}" onchange="updateMinTime('editDate', 'editTime')">
        <input id="editTime" type="time" value="${a.time}">
        <input id="editCap" type="number" value="${a.capacity}">
        <input id="editDuration" type="number" value="${a.duration}">
        <div style="display: flex; gap: 10px;">
            <button class="btn primary" onclick="saveEventEdit(${e})" style="flex: 1;">Save</button>
            <button class="btn" onclick="closeModal()" style="flex: 1;">Cancel</button>
        </div>`,
    o.style.display = "flex", updateMinTime("editDate", "editTime");
}
async function saveEventEdit(e) {
    const t = {
        date: document.getElementById("editDate").value, time: document.getElementById("editTime").value, title: capitalizeWords(document.getElementById("editTitle").value),
        venue: document.getElementById("editVenue").value, capacity: document.getElementById("editCap").value,
        duration: document.getElementById("editDuration").value, category: document.getElementById("editCategory").value, regNumber: currentUser.regNumber
    };
    if (new Date(`${t.date}T${t.time}`) < new Date) return void alert("Event date and time must be in the future.");
    const n = await fetch(API + "/events/" + e, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(t) });
    n.ok ? (closeModal(), renderOrganizer(), renderEvents()) : alert("Error: " + ((await n.json()).error || "Failed to update event."));
}
async function renderOrganizer(){
    const res = await fetch(API + "/events");
    const data = await res.json();
    const c = document.getElementById("screen-organizer");
    
    c.innerHTML = `
        <h2>Organizer Dashboard</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" onclick="createEventScreen()" style="flex:1;">+ Create Event</button>
            <button class="btn" onclick="showCategoryStats()" style="flex:1;">üìä Event Categories Dashboard</button>
        </div>
    `;
    
    if (!data.ok) {
        c.innerHTML += `<p class="muted">Could not load events.</p>`;
        return;
    }
    
    const myEvents = data.events.filter(e => e.creatorRegNumber === currentUser.regNumber);
    if (myEvents.length === 0) {
        c.innerHTML += `<p class="muted">You have not created any events yet.</p>`;
        return;
    }
    
    const now = new Date;
    const upcomingAndLive = myEvents.filter(e => {
        const endTime = new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000);
        return endTime >= now;
    }).sort((a, b) => parseEventDateTime(a.date, a.time) - parseEventDateTime(b.date, b.time));
    
    const past = myEvents.filter(e => {
        const endTime = new Date(parseEventDateTime(e.date, e.time).getTime() + (e.duration || 0) * 60000);
        return endTime < now;
    }).sort((a, b) => parseEventDateTime(b.date, b.time) - parseEventDateTime(a.date, a.time));
    
    const renderSection = (title, events, highlight) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'section-wrapper' + (highlight ? ' highlight-border' : '');
        const h = document.createElement('h3');
        h.className = 'section-title';
        h.textContent = title;
        wrapper.appendChild(h);
        if (events.length === 0) {
            const p = document.createElement('p');
            p.className = 'muted';
            p.textContent = 'No events in this section.';
            wrapper.appendChild(p);
            c.appendChild(wrapper);
            return;
        }
        events.forEach(e => {
            const div = document.createElement("div");
            div.className = "card";
            const startTime = parseEventDateTime(e.date, e.time);
            const endTime = new Date(startTime.getTime() + (e.duration || 0) * 60000);
            let status = "upcoming";
            if (now >= startTime && now < endTime) status = "live";
            else if (now >= endTime) status = "past";
            div.innerHTML = `
                <div class="category-badge">${e.category || 'General'}</div>
                <b style="font-size:1.05rem;color:#fbbf24;">${capitalizeWords(e.title)}</b>
                <div class="kv organizer-kv">
                    <b>Venue:</b> <span class="value">${capitalizeWords(e.venue)}</span>
                    <b>Date:</b> <span class="value">${e.date}</span>
                    <b>Time:</b> <span class="value">${e.time}</span>
                    <b>Seats:</b> <span class="value">${e.taken}/${e.capacity}</span>
                </div>`;
            let buttons = `<button class="btn" onclick="showEventBookings(${e.id})">View Bookings</button><button class="btn" onclick='showEventIdCard(${JSON.stringify(e)})'>üí≥ View Event ID</button><button class="btn" onclick='openOrganizerMessages(${e.id})'>üí¨ Messages</button><button class="btn" onclick='openWaitlistModal(${e.id}, "${e.title.replace(/"/g,'&quot;')}")'>üïí Waitlist</button>`;
            buttons += `<button class="btn" onclick='openVolunteersModal(${e.id}, "${e.title.replace(/"/g,'&quot;')}")'>ü§ù Volunteers</button>`;
            if (status === "live") {
                buttons += `<button class="btn" onclick='showEventMediaModal(${JSON.stringify(e)})'>üñºÔ∏è Manage Media</button>`;
            } else if (status === "upcoming") {
                buttons += `<button class="btn" onclick='showEventMediaModal(${JSON.stringify(e)})'>üñºÔ∏è Manage Media</button><button class="btn" onclick="editEvent(${e.id})">‚úèÔ∏è Edit</button><button class="btn" onclick="deleteEvent(${e.id}, '${e.title}')">üóëÔ∏è Delete</button>`;
            } else if (status === "past") {
                // Allow managing media for past events too
                buttons += `<button class="btn" onclick='showEventMediaModal(${JSON.stringify(e)})'>üñºÔ∏è Manage Media</button>`;
            }
            div.innerHTML += `<div class="card-buttons">${buttons}</div>`;
            wrapper.appendChild(div);
        });
        c.appendChild(wrapper);
    };
    
    renderSection("Upcoming & Live Events", upcomingAndLive, false);
    renderSection("Past Events", past, true);
}

// Organizer: Category stats
async function showCategoryStats(){
    const res = await fetch(API + "/events");
    const data = await res.json();
    const c = document.getElementById("screen-organizer");
    if (!data.ok) { alert("Failed to load events"); return; }
    const myEvents = (data.events||[]).filter(e => e.creatorRegNumber === currentUser.regNumber);
    const counts = {};
    myEvents.forEach(e => { const k = e.category || 'Other'; counts[k] = (counts[k]||0) + 1; });
    const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
    const summary = entries.map(([k,v]) => `${k}: ${v} event${v!==1?'s':''}`).join(', ');
    c.innerHTML = `
        <h2>Event Categories Dashboard</h2>
        <p class="muted">${summary || 'No events created yet.'}</p>
        <div class="card">
            ${entries.map(([k,v]) => `<div class="kv"><b>${k}</b> <span class="value">${v}</span></div>`).join('')}
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" onclick="renderOrganizer()">Back</button>
        </div>
    `;
}

// Organizer: Waitlist dashboard per event
async function showWaitlistDashboard(){
    const res = await fetch(API + "/events");
    const data = await res.json();
    const c = document.getElementById("screen-organizer");
    if (!data.ok) { alert("Failed to load events"); return; }
    const myEvents = (data.events||[]).filter(e => e.creatorRegNumber === currentUser.regNumber);
    if (myEvents.length === 0) { c.innerHTML = `<h2>Waitlist System</h2><p class="muted">No events.</p><button class="btn" onclick="renderOrganizer()">Back</button>`; return; }
    c.innerHTML = `<h2>Waitlist System</h2>`;
    myEvents.forEach(e => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<b>${capitalizeWords(e.title)}</b><div class="muted">${e.date} ${e.time} ‚Ä¢ ${capitalizeWords(e.venue)}</div><div id="wl-${e.id}" class="muted">Loading waitlist‚Ä¶</div>`;
        c.appendChild(card);
        loadWaitlistForEvent(e.id);
    });
    const backRow = document.createElement('div'); backRow.style.display='flex'; backRow.style.gap='10px'; backRow.style.marginTop='10px';
    backRow.innerHTML = `<button class="btn" onclick="renderOrganizer()">Back</button>`; c.appendChild(backRow);
}

async function loadWaitlistForEvent(eventId){
    try{
        const res = await fetch(`${API}/waitlist/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        const el = document.getElementById(`wl-${eventId}`);
        if (!res.ok || !data.ok) { el.textContent = 'Failed to load waitlist.'; return; }
        if (!data.waitlist || data.waitlist.length === 0) { el.textContent = 'No users on waitlist.'; return; }
        el.innerHTML = data.waitlist.map((w,i)=> `<div class="kv"><b>#${i+1}</b> <span class="value">${w.name} (${w.regNumber})</span></div>`).join('');
    }catch(err){ const el = document.getElementById(`wl-${eventId}`); if(el) el.textContent = 'Failed to load waitlist.'; }
}

function openWaitlistModal(eventId, title){
    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
            <h3 style="margin:0;">Waitlist ‚Äì ${capitalizeWords(title)}</h3>
        </div>
        <div id="waitlist-modal-list" class="card" style="max-height:360px; overflow:auto"></div>
    `;
    modal.style.display = 'flex';
    loadWaitlistModalList(eventId);
}

async function loadWaitlistModalList(eventId){
    try{
        const res = await fetch(`${API}/waitlist/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        const list = document.getElementById('waitlist-modal-list');
        if(!res.ok || !data.ok){ list.innerHTML = '<p class="muted">Failed to load waitlist.</p>'; return; }
        if(!data.waitlist || data.waitlist.length===0){ list.innerHTML = '<p class="muted">No users on waitlist.</p>'; return; }
        list.innerHTML = data.waitlist.map((w,i)=> `<div class="kv"><b>#${i+1}</b> <span class="value">${w.name} (${w.regNumber})</span></div>`).join('');
    }catch(err){ const list = document.getElementById('waitlist-modal-list'); if(list) list.innerHTML = '<p class="muted">Failed to load waitlist.</p>'; }
}

// Organizer: Volunteers modal
function openVolunteersModal(eventId, title){
    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
            <h3 style="margin:0;">Volunteers ‚Äì ${capitalizeWords(title)}</h3>
        </div>
        <div class="card">
            <div style="display:flex; flex-direction:column; gap:8px;">
                <input id="volAddReg" placeholder="RegNumber">
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn" onclick="verifyVolunteerReg('volAddReg','volAddStatus','volAddRoleRow', currentUser.regNumber)">Verify</button>
                    <button class="btn" onclick="(document.getElementById('volAddReg').value='',(document.getElementById('volAddStatus').textContent=''),(document.getElementById('volAddRoleRow').style.display='none'))">Clear</button>
                    <span id="volAddStatus" class="muted"></span>
                </div>
                <div id="volAddRoleRow" style="display:none;">
                    <select id="volAddRole">
                        ${VOL_ROLES.map(r=>`<option>${r}</option>`).join('')}
                    </select>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn primary" onclick="addVolunteer(${eventId})">Add</button>
                </div>
            </div>
        </div>
        <div id="volList" class="card" style="max-height:360px; overflow:auto; margin-top:10px"></div>
    `;
    modal.style.display = 'flex';
    loadVolunteersList(eventId);
}
async function loadVolunteersList(eventId){
    try{
        const res = await fetch(`${API}/volunteers/${eventId}?organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        const el = document.getElementById('volList');
        if(!res.ok || !data.ok){ el.textContent = 'Failed to load volunteers.'; return; }
        if(!data.volunteers || data.volunteers.length===0){ el.textContent = 'No volunteers yet.'; return; }
        el.innerHTML = data.volunteers.map(v => `
            <div class="kv" style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:10px; flex:1;">
                    <b style="min-width:48px;">${v.volunteerId}</b>
                    <span class="value">${v.name} (${v.regNumber}) ‚Äî ${v.role||''}</span>
                </div>
                <button class="btn" style="border-color: var(--red-accent); color: var(--red-accent);" onclick="removeVolunteer(${eventId}, '${v.regNumber}')">Cancel</button>
            </div>`).join('');
        // Update role dropdown to exclude used roles
        const used = new Set((data.volunteers||[]).map(v=> v.role));
        const roleSel = document.getElementById('volAddRole');
        if(roleSel){
            roleSel.innerHTML = VOL_ROLES.filter(r=> !used.has(r)).map(r=>`<option>${r}</option>`).join('') || '<option disabled selected>All roles used</option>';
        }
    }catch(err){ const el = document.getElementById('volList'); if(el) el.textContent='Failed to load volunteers.'; }
}
async function addVolunteer(eventId){
    const input = document.getElementById('volAddReg');
    const roleSel = document.getElementById('volAddRole');
    if(!input) return;
    const reg = String(input.value||'').trim();
    const role = String(roleSel?.value||'').trim();
    if(!reg) return alert('Enter reg number');
    if(!role) return alert('Select a role');
    const res = await fetch(`${API}/volunteers/add`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, organizerReg: currentUser.regNumber, regNumber: reg, role }) });
    const data = await res.json();
    if(res.ok && data.ok){ alert('Volunteer added.'); loadVolunteersList(eventId); renderEvents(); }
    else { alert('Error: ' + (data.error || 'Failed to add volunteer.')); }
}
async function removeVolunteer(eventId, reg){
    if(!confirm('Cancel this volunteer?')) return;
    const res = await fetch(`${API}/volunteers/remove`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, organizerReg: currentUser.regNumber, regNumber: reg }) });
    const data = await res.json();
    if(res.ok && data.ok){ alert('Volunteer cancelled.'); loadVolunteersList(eventId); renderEvents(); }
    else { alert('Error: ' + (data.error || 'Failed to cancel volunteer.')); }
}

// Volunteer ID Card modal for current user (from Home)
async function openVolunteerIdCard(eventId){
    try{
        const res = await fetch(API + '/events');
        const data = await res.json();
        if(!res.ok || !data.ok) return alert('Failed to load');
        const e = (data.events||[]).find(x=> x.id === eventId);
        if(!e) return alert('Event not found');
        const v = (e.volunteers||[]).find(v=> v.regNumber === currentUser.regNumber) || {};
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        body.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <a class="map-back-arrow" onclick="closeModal()">‚Üê</a>
                <h3 style="margin:0;">Volunteer ID</h3>
            </div>
            <div class="card" style="border-color:#10b981; background:#052e1c;">
                <div class="kv">
                    <b>Volunteer</b> <span class="value">${capitalizeWords(e.title)}</span>
                    <b>Organizer</b> <span class="value">${capitalizeWords(e.creatorName || '')}</span>
                    <b>Date</b> <span class="value">${e.date}</span>
                    <b>Time</b> <span class="value">${e.time}</span>
                    <b>Role</b> <span class="value">${v.role || ''}</span>
                    <b>Volunteer ID</b> <span class="value">${v.volunteerId || ''}</span>
                </div>
            </div>`;
        modal.style.display = 'flex';
    }catch(err){ alert('Failed to open ID'); }
}

// User: Join waitlist
async function joinWaitlist(eventId){
    try{
        const res = await fetch(API + '/waitlist', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, regNumber: currentUser.regNumber }) });
        const data = await res.json();
        if(res.ok && data.ok){ alert('‚úÖ Added to waitlist. You will be auto-booked when a seat opens.'); renderEvents(); }
        else { alert('‚ùå ' + (data.error || 'Failed to join waitlist')); }
    }catch(err){ alert('‚ùå Network error'); }
}

function openOrganizerMessages(eventId){
    const body = document.getElementById('modal-body');
    body.innerHTML = `<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><a class="map-back-arrow" onclick="closeModal()">‚Üê</a><h3 style="margin:0;">üí¨ Messages</h3></div><div class="card"><div class="sub-nav"><button id="tabPrimary" class="sub-nav-btn active" onclick="setConvTab('primary')">Primary (Volunteers)</button><button id="tabGeneral" class="sub-nav-btn" onclick="setConvTab('general')">General</button></div><div id="convList" style="max-height:360px; overflow:auto; padding:8px;"></div></div>`;
    document.getElementById('modal').style.display = 'flex';
    loadOrganizerConversations(eventId);
}

async function loadOrganizerConversations(eventId){
    try{
        const res = await fetch(`${API}/messages/conversations?eventId=${eventId}&organizerReg=${currentUser.regNumber}`);
        const data = await res.json();
        window.__convCache = data.users || [];
        window.__convEventId = eventId;
        renderConvList('primary');
    }catch(err){ document.getElementById('convList').innerHTML = '<p class="muted">Error loading conversations.</p>'; }
}
function setConvTab(tab){
    document.getElementById('tabPrimary').classList.toggle('active', tab==='primary');
    document.getElementById('tabGeneral').classList.toggle('active', tab==='general');
    renderConvList(tab);
}
function renderConvList(tab){
    const list = document.getElementById('convList');
    const users = (window.__convCache||[]).filter(u => tab==='primary' ? u.volunteer : !u.volunteer);
    if(users.length===0){ list.innerHTML = '<p class="muted">No messages.</p>'; return; }
    list.innerHTML = users.map(u => {
        const dot = u.unread > 0 ? `<span style='display:inline-block; width:8px; height:8px; background:#ef4444; border-radius:50%; margin-left:6px;'></span>` : '';
        return `<div class="detail-item" style="cursor:pointer" onclick="openOrganizerThread(${window.__convEventId}, '${u.regNumber}', '${(u.name||'').replace(/'/g, "&#39;")}')"><b>${capitalizeWords(u.name||u.regNumber)}</b>${dot}<div class="muted">${u.regNumber}</div></div>`;
    }).join('');
}

function openOrganizerThread(eventId, studentReg, studentName){
    const body = document.getElementById('modal-body');
    body.innerHTML = `
        <div class="chat-container" style="height:75%; display:flex; flex-direction:column; overflow:hidden">
          <h3 style="margin-top:0">üí¨ Chat ‚Äì ${capitalizeWords(studentName||studentReg)}</h3>
          <div id="chatThread" style="flex:1; overflow-y:auto; overflow-x:hidden; background: #111; padding:10px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px"></div>
          <div class="chat-composer">
              <input id="chatInput" class="chat-input" placeholder="Message" onkeydown="if(event.key==='Enter'){sendOrganizerReply(${eventId}, '${studentReg}')}" />
              <input type="file" id="orgChatFile" accept="image/*,video/*" style="display:none" onchange="sendOrganizerMedia(${eventId}, '${studentReg}')">
              <button class="chat-attach" title="Attach" onclick="document.getElementById('orgChatFile').click()">üìé</button>
              <button class="chat-send" title="Send" onclick="sendOrganizerReply(${eventId}, '${studentReg}')">‚û§</button>
          </div>
          <div id="chatMsg" class="muted" style="margin:6px 0;"></div>
          <div style="display:flex; justify-content:flex-end;"><button class="btn" style="width:auto" onclick="openOrganizerMessages(${eventId})">Back</button></div>
        </div>
    `;
    document.getElementById('modal').style.display = 'flex';
    loadChatThread(eventId, currentUser.regNumber, studentReg);
}

async function sendOrganizerReply(eventId, studentReg){
    const input = document.getElementById('chatInput');
    const msgBar = document.getElementById('chatMsg');
    const text = (input.value||'').trim();
    if(!text){ msgBar.textContent = 'Type a message'; return; }
    const thread = document.getElementById('chatThread');
    thread.innerHTML += `<div style="text-align:right; margin:6px 0;"><span style="display:inline-block; padding:8px 10px; border-radius:10px; background:#2563eb; color:white; max-width:80%;">${text}</span><div class="muted" style="font-size:0.75rem;">sending‚Ä¶</div></div>`;
    thread.scrollTop = thread.scrollHeight;
    input.value = '';
    try{
        const res = await fetch(API + '/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId, fromReg: currentUser.regNumber, toReg: studentReg, text }) });
        const data = await res.json();
        if(res.ok && data.ok){ msgBar.textContent = '‚úÖ Message sent'; setTimeout(()=> msgBar.textContent = '', 1200); loadChatThread(eventId, currentUser.regNumber, studentReg); }
        else { msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send'); }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}

async function sendOrganizerMedia(eventId, studentReg){
    const input = document.getElementById('orgChatFile');
    const msgBar = document.getElementById('chatMsg');
    if(!input.files || input.files.length===0){ msgBar.textContent = 'Select an image or video (max 10MB)'; return; }
    const file = input.files[0];
    if(file.size > 10*1024*1024){ msgBar.textContent = '‚ùå File too large (max 10MB)'; return; }
    try{
        const form = new FormData();
        form.append('file', file);
        form.append('eventId', String(eventId));
        form.append('fromReg', currentUser.regNumber);
        form.append('toReg', studentReg);
        const res = await fetch(API + '/messages/media', { method:'POST', body: form });
        const data = await res.json();
        if(res.ok && data.ok){ msgBar.textContent = '‚úÖ Media sent'; setTimeout(()=> msgBar.textContent='', 1200); loadChatThread(eventId, currentUser.regNumber, studentReg); }
        else { msgBar.textContent = '‚ùå ' + (data.error || 'Failed to send media'); }
    }catch(err){ msgBar.textContent = '‚ùå Network error'; }
}
async function deleteEvent(e,t){if(confirm(`Are you sure you want to permanently delete the event "${t}"? This will notify all booked users and delete all associated media.`)){const t=await fetch(API+"/events/"+e,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({regNumber:currentUser.regNumber})});if(t.ok)alert("Event deleted."),renderOrganizer(),renderEvents();else{const e=await t.json();alert("Error: "+e.error)}}}
async function showEventMediaModal(e){const t=document.getElementById("modal-body"),n=await fetch(API+"/events"),a=await n.json(),i=a.events.find(t=>t.id===e.id);let o='<div class="media-grid">';i.media&&i.media.length>0?i.media.forEach(t=>{o+='<div class="media-item">',"photo"===t.type&&(o+=`<img src="http://localhost:5000${t.url}" onclick="showLightbox('${t.url}', 'photo')">`),"video"===t.type&&(o+=`<video src="http://localhost:5000${t.url}" onclick="showLightbox('${t.url}', 'video')"></video>`),o+=`<span class="delete-media-btn" onclick="deleteMedia(${t.id}, ${e.id})">‚úñ</span></div>`}):o+='<p class="muted" style="grid-column: 1 / -1;">No media uploaded for this event yet.</p>',o+="</div>",t.innerHTML=`<h3>Media for ${e.title}</h3>${o}<div style="display:flex; gap:10px;"><button class="btn primary" onclick="triggerMediaUpload(${e.id})">Upload Image/Video</button><input type="file" id="eventMediaFile" accept="image/*,video/*" style="display:none"></div>`,document.getElementById("modal").style.display="flex"}
async function deleteMedia(e,t){if(confirm("Are you sure you want to delete this media file? This action cannot be undone.")){const n=await fetch(`${API}/media/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({regNumber:currentUser.regNumber})});if(n.ok){const e=await fetch(API+"/events"),n=await e.json(),a=n.events.find(e=>e.id===t);showEventMediaModal(a)}else{const e=await n.json();alert("Error: "+(e.error||"Failed to delete media."))}}}
function triggerMediaUpload(e){const t=document.getElementById('eventMediaFile')||(()=>{const f=document.createElement('input');f.type='file';f.accept='image/*,video/*';f.style.display='none';f.id='eventMediaFile';document.body.appendChild(f);return f;})();t.onchange=()=>{t.files&&t.files[0]&&uploadMediaForEvent(e,t.files[0])};t.click()}
async function uploadMediaForEvent(eventId,file){try{const fd=new FormData();fd.append('file',file);fd.append('eventId',String(eventId));fd.append('regNumber',currentUser.regNumber);const res=await fetch(API+'/media',{method:'POST',body:fd});const data=await res.json();if(res.ok&&data.ok){const evRes=await fetch(API+"/events");const evData=await evRes.json();const ev=evData.events.find(e=>e.id===eventId);showEventMediaModal(ev)}else{alert('‚ùå '+(data.error||'Upload failed'))}}catch(err){alert('‚ùå Network error')}}

// ---------- Notifications & Misc Helpers ----------
async function checkEventStates(){if(!currentUser)return;const res=await fetch(API+"/events");const data=await res.json();if(!data.ok)return;const now=new Date;const upcomingCount=data.events.filter(e=>{const endTime=new Date(parseEventDateTime(e.date,e.time).getTime()+(e.duration||0)*6e4);return endTime>=now}).length;if(-1===lastUpcomingCount)lastUpcomingCount=upcomingCount;else if(upcomingCount<lastUpcomingCount){lastUpcomingCount=upcomingCount;const currentScreen=document.querySelector('.content[style*="block"]').id.replace("screen-","");"home"===currentScreen&&renderEvents(),"media"===currentScreen&&renderMedia()}}

// Event start notifications with time gaps (15, 20, 20, 5 minutes) and live notifications
async function checkEventStartNotifications() {
    if (!currentUser) return;
    
    try {
        const res = await fetch(API + "/events");
        const data = await res.json();
        if (!data.ok) return;
        
        const now = new Date();
        const notificationGaps = [60, 45, 25, 5]; // Minutes before event start (60-45=15, 45-25=20, 25-5=20, 5-0=5)
        
        for (const event of data.events) {
            const eventStart = parseEventDateTime(event.date, event.time);
            const eventEnd = new Date(eventStart.getTime() + (event.duration || 0) * 60 * 1000);
            const timeUntilStart = eventStart.getTime() - now.getTime();
            const timeUntilEnd = eventEnd.getTime() - now.getTime();
            const minutesUntilStart = Math.floor(timeUntilStart / (1000 * 60));
            
            // Debug logging
            console.log(`Event: ${event.title}, Minutes until start: ${minutesUntilStart}`);
            
            // Check if event is starting within the next hour and matches our notification gaps
            if (timeUntilStart > 0 && timeUntilStart <= 60 * 60 * 1000) { // Within next hour
                for (const gap of notificationGaps) {
                    // Fix the logic: check if we're within 1 minute of the gap
                    if (minutesUntilStart <= gap && minutesUntilStart >= gap - 1) {
                        // Check if we already sent this notification
                        const notificationKey = `event_${event.id}_${gap}min`;
                        if (!localStorage.getItem(notificationKey)) {
                            // Send notification
                            const message = `‚è∞ "${event.title}" starts in ${minutesUntilStart} minute${minutesUntilStart !== 1 ? 's' : ''}!`;
                            
                            console.log(`Sending notification: ${message}`);
                            
                            // Show notification ticker
                            const notificationTicker = document.getElementById("notificationTicker");
                            if (notificationTicker) {
                                notificationTicker.innerHTML = message;
                                notificationTicker.style.display = "block";
                                setTimeout(() => {
                                    notificationTicker.style.display = "none";
                                }, 3000);
                            }
                            
                            // Mark as sent
                            localStorage.setItem(notificationKey, 'sent');
                            
                            // Clean up old notifications (older than 2 hours)
                            setTimeout(() => {
                                localStorage.removeItem(notificationKey);
                            }, 2 * 60 * 60 * 1000);
                            
                            break; // Only send one notification per check
                        }
                    }
                }
            }
            
            // Check if event is live (started but not ended)
            if (timeUntilStart <= 0 && timeUntilEnd > 0) {
                // Check if we already sent live notification
                const liveNotificationKey = `event_${event.id}_live`;
                if (!localStorage.getItem(liveNotificationKey)) {
                    // Send live notification
                    const message = `üî• "${event.title}" is LIVE now!`;
                    
                    console.log(`Sending live notification: ${message}`);
                    
                    // Show notification ticker
                    const notificationTicker = document.getElementById("notificationTicker");
                    if (notificationTicker) {
                        notificationTicker.innerHTML = message;
                        notificationTicker.style.display = "block";
                        setTimeout(() => {
                            notificationTicker.style.display = "none";
                        }, 4000); // Show live notifications a bit longer
                    }
                    
                    // Mark as sent
                    localStorage.setItem(liveNotificationKey, 'sent');
                    
                    // Clean up live notification after event ends (with some buffer)
                    setTimeout(() => {
                        localStorage.removeItem(liveNotificationKey);
                    }, timeUntilEnd + 5 * 60 * 1000); // 5 minutes after event ends
                }
            }
        }
    } catch (error) {
        console.error('Error checking event notifications:', error);
    }
}
function updateMinTime(e,t){const n=document.getElementById(e),a=document.getElementById(t),i=new Date,o=i.toISOString().split("T")[0];n.value===o?a.min=String(i.getHours()).padStart(2,"0")+":"+String(i.getMinutes()).padStart(2,"0"):a.min=null}
async function renderNotifications(){const e=await fetch(API+"/notifications/"+currentUser.regNumber),t=await e.json();const n=document.getElementById("screen-notifications");if(n.innerHTML=`<button class="btn" onclick="markAllAsRead()">Mark all as read</button>`,!t.ok||0===t.notifications.length)return void(n.innerHTML+=`<p class="muted">No notifications yet.</p>`);t.notifications.forEach(o=>{const t=document.createElement("div");t.className="card";const a=o.read?o.msg:`<strong>${o.msg}</strong>`;t.innerHTML=`${a}<br><span class="muted">${new Date(o.time).toLocaleString()}</span>`;t.onclick=()=>handleNotificationClick(o);n.appendChild(t)})}

async function handleNotificationClick(notif){
    if(notif && notif.type === 'chat' && notif.eventId){
        try{
            const res = await fetch(API + '/events');
            const data = await res.json();
            if(!data.ok) return;
            const event = data.events.find(e => e.id === Number(notif.eventId));
            if(!event) return;
            const otherReg = currentUser.regNumber === notif.fromReg ? notif.toReg : notif.fromReg;
            // If current user is organizer, open organizer thread; otherwise open student chat
            if(currentUser.regNumber === event.creatorRegNumber){
                openOrganizerThread(event.id, otherReg, (event.bookings.find(b=>b.regNumber===otherReg)?.name)||otherReg);
            } else {
                openEventChat(event.id, event.title, event.creatorRegNumber);
            }
        }catch(err){}
    }
}
async function markAllAsRead(){await fetch(API+"/notifications/mark-read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({regNumber:currentUser.regNumber})}),renderNotifications(),pollNotifications()}
async function pollNotifications(){if(!currentUser)return;try{const e=await fetch(API+"/notifications/"+currentUser.regNumber),t=await e.json();const n=document.getElementById("notificationTicker");const tickerTextEl=document.getElementById("notificationTickerText");const now=Date.now();const bannerActive=now<welcomeBannerUntil;if(t.ok&&t.notifications.length>0){const r=t.notifications.filter(e=>!e.read).length;if(r>0&&!bannerActive){tickerTextEl.textContent=`üîî You have ${r} unread notification(s)! Click to view.`;if(document.getElementById("screen-notifications").style.display!=="block"){n.style.display="block";tickerTextEl.style.animationPlayState='running';}}else if(!bannerActive){n.style.display="none";tickerTextEl.style.animationPlayState='paused';tickerTextEl.style.transform='translateX(0)';}}else if(!bannerActive){n.style.display="none"}}catch(e){}}
function parseEventDateTime(e,t){if(!t)return new Date(e);if(/am|pm/i.test(t)){let[n,a]=t.split(" ");let[i,o]=n.split(":").map(Number);"PM"===a.toUpperCase()&&i<12&&(i+=12),"AM"===a.toUpperCase()&&12===i&&(i=0);return new Date(`${e}T${String(i).padStart(2,"0")}:${o.toString().padStart(2,"0")}:00`)}return new Date(`${e}T${t}:00`)}
async function showEventBookings(e){const t=await fetch(API+"/events"),n=await t.json(),a=n.events.find(t=>t.id===e);window.__eventsCache=n.events;const i=document.getElementById("modal"),o=document.getElementById("modal-body");if(o.innerHTML=`<h3>${a.title} ‚Äì Bookings</h3>`,0===a.bookings.length)o.innerHTML+='<p class="muted">No bookings yet.</p>';else{let tHtml="<table style='width:100%; border-collapse: collapse;'>";tHtml+="<tr style='background:#111'><th style='border:1px solid #333; padding:8px; text-align:left'>Seat</th><th style='border:1px solid #333; padding:8px; text-align:left'>Name</th><th style='border:1px solid #333; padding:8px; text-align:left'>Reg</th><th style='border:1px solid #333; padding:8px; text-align:left'>Role</th><th style='border:1px solid #333; padding:8px; text-align:left'>Action</th></tr>";a.bookings.forEach(r=>{tHtml+=`<tr><td style='border:1px solid #333; padding:8px'>${r.seat}</td><td style='border:1px solid #333; padding:8px'>${r.name}</td><td style='border:1px solid #333; padding:8px'>${r.regNumber}</td><td style='border:1px solid #333; padding:8px'>${r.role}</td><td style='border:1px solid #333; padding:8px'><button class='btn' style='padding:6px 10px; width:auto; color: var(--red-accent); border-color: var(--red-accent);' onclick="organizerCancelBooking(${a.id}, '${r.regNumber}')">Cancel</button></td></tr>`}),tHtml+="</table>",o.innerHTML+=tHtml,o.innerHTML+=`<div style="margin-top:16px; text-align:center;"><button class="btn primary" onclick="downloadBookingsReport(${a.id}, '${a.title.replace(/'/g, "&#39;")}', '${a.date}')">üìä Download Report</button></div>`}i.style.display="flex"}
async function organizerCancelBooking(eventId,targetReg){if(!currentUser||currentUser.role!=="ORGANIZER")return; if(!confirm("Cancel this user's ticket?"))return;try{const e=await fetch(API+"/tickets/admin-cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventId,targetRegNumber:targetReg,organizerRegNumber:currentUser.regNumber})}),t=await e.json();e.ok&&t.ok?(alert("Ticket cancelled. User will be notified."),showEventBookings(eventId),renderEvents()):alert("Error: "+(t.error||"Failed to cancel booking"))}catch(e){alert("Network error")}}
async function downloadBookingsReport(eventId, eventTitle, eventDate){
    try{
        let event = window.__eventsCache?.find(e => e.id === eventId);
        if(!event){
            const res = await fetch(API + '/events');
            const data = await res.json();
            event = data.events.find(e => e.id === eventId);
        }
        if(!event || !event.bookings || event.bookings.length === 0){
            alert('No bookings data available');
            return;
        }
        const reportHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings Report - ${eventTitle}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f8fafc; color: #1a202c; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; text-align: center; }
        .header h1 { margin: 0 0 8px 0; font-size: 28px; font-weight: 600; }
        .header p { margin: 0; opacity: 0.9; font-size: 16px; }
        .content { padding: 24px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: 700; color: #2d3748; margin-bottom: 4px; }
        .stat-label { font-size: 14px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th { background: #4a5568; color: white; padding: 16px 12px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 16px 12px; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        tr:hover { background: #f7fafc; }
        tr:last-child td { border-bottom: none; }
        .ticket-id { font-family: 'Courier New', monospace; font-weight: 600; color: #2b6cb0; }
        .reg-number { font-family: 'Courier New', monospace; font-weight: 500; color: #4a5568; }
        .role-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .role-organizer { background: #fed7d7; color: #c53030; }
        .role-student { background: #c6f6d5; color: #2f855a; }
        .footer { background: #f7fafc; padding: 16px 24px; text-align: center; color: #718096; font-size: 14px; border-top: 1px solid #e2e8f0; }
        @media print { body { background: white; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Bookings Report</h1>
            <p>${eventTitle} ‚Ä¢ ${eventDate}</p>
        </div>
        <div class="content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number">${event.bookings.length}</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${event.capacity}</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round((event.bookings.length / event.capacity) * 100)}%</div>
                    <div class="stat-label">Occupancy Rate</div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Seat #</th>
                        <th>Ticket ID</th>
                        <th>Name</th>
                        <th>Registration #</th>
                        <th>Role</th>
                        <th>Event Date</th>
                        <th>Booking Date</th>
                        <th>Booking Time</th>
                    </tr>
                </thead>
                <tbody>
                    ${event.bookings.map(booking => {
                        const bookingDate = booking.bookedAt ? new Date(booking.bookedAt) : new Date();
                        const eventDateTime = new Date(`${eventDate}T${event.time}`);
                        return `
                            <tr>
                                <td><strong>${booking.seat}</strong></td>
                                <td><span class="ticket-id">T-${String(booking.seat).padStart(2, '0')}</span></td>
                                <td><strong>${booking.name || 'N/A'}</strong></td>
                                <td><span class="reg-number">${booking.regNumber}</span></td>
                                <td><span class="role-badge role-${booking.role === 'O' ? 'organizer' : 'student'}">${booking.role === 'O' ? 'Organizer' : 'Student'}</span></td>
                                <td>${eventDateTime.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                <td>${bookingDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
                                <td>${bookingDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <div class="footer">
            <p>Generated on ${new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
        </div>
    </div>
</body>
</html>`;
        const newWindow = window.open('', '_blank');
        newWindow.document.write(reportHtml);
        newWindow.document.close();
    }catch(err){
        alert('Error generating report: ' + err.message);
    }
}
async function renderProfile(){
    if(!currentUser) return;
    const p = document.getElementById("screen-profile");
    p.innerHTML = `
        <h2>My Profile</h2>
        <div class="profile-details">
            <div class="detail-item"><label>Full Name</label><span>${capitalizeWords(currentUser.name || '')} ${capitalizeWords(currentUser.surname || '')}</span></div>
            <div class="detail-item"><label>Registration Number</label><span>${currentUser.regNumber}</span></div>
            <div class="detail-item"><label>Email</label><span>${currentUser.email}</span></div>
            <div class="detail-item"><label>Phone</label><span>${currentUser.phone}</span></div>
            <div class="detail-item"><label>Age</label><span>${currentUser.age}</span></div>
            <div class="detail-item"><label>Gender</label><span>${currentUser.gender}</span></div>
            ${currentUser.department ? `<div class="detail-item"><label>Department</label><span>${currentUser.department}</span></div>` : ''}
            ${currentUser.bloodGroup ? `<div class="detail-item"><label>Blood Group</label><span>${currentUser.bloodGroup}</span></div>` : ''}
            ${currentUser.address ? `<div class="detail-item"><label>Address</label><span>${currentUser.address}</span></div>` : ''}
            ${currentUser.branch ? `<div class="detail-item"><label>Branch</label><span>${currentUser.branch}</span></div>` : ''}
            ${currentUser.pincode ? `<div class="detail-item"><label>Pincode</label><span>${currentUser.pincode}</span></div>` : ''}
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn primary" onclick="showEditProfile()">‚úèÔ∏è Edit Profile</button>
            <button class="btn" onclick="showIdCard()">üÜî View ID Card</button>
        </div>
    `;
}

function showEditProfile() {
    const p = document.getElementById("screen-profile");
    
    // Department options for NITK
    const departments = [
        "Computer Science & Engineering",
        "Information Technology", 
        "Electronics & Communication Engineering",
        "Electrical & Electronics Engineering",
        "Mechanical Engineering",
        "Civil Engineering",
        "Chemical Engineering",
        "Metallurgical & Materials Engineering",
        "Mining Engineering",
        "Petroleum Engineering",
        "Aerospace Engineering",
        "Biotechnology",
        "Industrial & Production Engineering",
        "Manufacturing Science & Engineering",
        "Ocean Engineering & Naval Architecture",
        "Architecture",
        "Mathematics",
        "Physics",
        "Chemistry",
        "Humanities & Social Sciences",
        "Management Studies"
    ];
    
    const bloodGroups = ["A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"];
    
    let departmentOptions = departments.map(dept => 
        `<option value="${dept}" ${currentUser.department === dept ? 'selected' : ''}>${dept}</option>`
    ).join('');
    
    let bloodGroupOptions = bloodGroups.map(bg => 
        `<option value="${bg}" ${currentUser.bloodGroup === bg ? 'selected' : ''}>${bg}</option>`
    ).join('');
    
    p.innerHTML = `
        <h2>Edit Profile</h2>
        <div class="card">
            <h3>Additional Information</h3>
            
            <div style="margin-bottom: 16px;">
                <label for="editDepartment" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Department:</label>
                <select id="editDepartment" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; background: #f7fafc; color: #2d3748; cursor: pointer;">
                    <option value="" style="color: #718096;">Select Department</option>
                    ${departmentOptions}
                </select>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editBloodGroup" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Blood Group:</label>
                <select id="editBloodGroup" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; background: #f7fafc; color: #2d3748; cursor: pointer;">
                    <option value="" style="color: #718096;">Select Blood Group</option>
                    ${bloodGroupOptions}
                </select>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editAddress" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Address:</label>
                <textarea id="editAddress" placeholder="Enter your complete address" rows="3" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-family: inherit; font-size: 1rem; resize: vertical; min-height: 80px; box-sizing: border-box; background: #f7fafc; color: #2d3748;">${currentUser.address || ''}</textarea>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editBranch" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Branch:</label>
                <input id="editBranch" type="text" placeholder="Enter your branch" value="${currentUser.branch || ''}" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f7fafc; color: #2d3748;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="editPincode" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-primary);">Pincode:</label>
                <input id="editPincode" type="text" placeholder="Enter pincode" value="${currentUser.pincode || ''}" maxlength="6" style="width: 100%; padding: 12px; border: 2px solid #4a5568; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f7fafc; color: #2d3748;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn primary" onclick="saveProfile()" style="flex: 1;">üíæ Save Profile</button>
                <button class="btn" onclick="renderProfile()" style="flex: 1;">‚ùå Cancel</button>
            </div>
            
            <div id="profileMsg" class="muted" style="margin-top: 10px;"></div>
        </div>
    `;
}

async function saveProfile() {
    const department = document.getElementById("editDepartment").value;
    const bloodGroup = document.getElementById("editBloodGroup").value;
    const address = document.getElementById("editAddress").value;
    const branch = document.getElementById("editBranch").value;
    const pincode = document.getElementById("editPincode").value;
    const msg = document.getElementById("profileMsg");
    
    // Validate pincode
    if (pincode && (!/^\d{6}$/.test(pincode))) {
        msg.textContent = "‚ùå Pincode must be 6 digits";
        return;
    }
    
    msg.textContent = "‚è≥ Saving profile...";
    
    try {
        const res = await fetch(API + "/profile", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                regNumber: currentUser.regNumber,
                department,
                bloodGroup,
                address,
                branch,
                pincode
            })
        });
        
        const data = await res.json();
        
        if (res.ok && data.ok) {
            msg.textContent = "‚úÖ Profile saved successfully!";
            
            // Update current user data
            currentUser.department = department;
            currentUser.bloodGroup = bloodGroup;
            currentUser.address = address;
            currentUser.branch = branch;
            currentUser.pincode = pincode;
            
            // Update saved session
            saveUserSession(currentUser);
            
            // Show success message
            setTimeout(() => {
                const notificationTicker = document.getElementById("notificationTicker");
                if (notificationTicker) {
                    notificationTicker.innerHTML = "‚úÖ Profile updated successfully!";
                    notificationTicker.style.display = "block";
                    setTimeout(() => {
                        notificationTicker.style.display = "none";
                    }, 2000);
                }
            }, 500);
            
            // Return to profile view after 1.5 seconds
            setTimeout(() => {
                renderProfile();
            }, 1500);
        } else {
            msg.textContent = "‚ùå " + (data.error || "Failed to save profile");
        }
    } catch (error) {
        msg.textContent = "‚ùå Network error: " + error.message;
    }
}
function showTicketDetail(e){const t=document.getElementById("modal-body");t.innerHTML=`<h3>üéüÔ∏è Ticket</h3><b>${e.eventTitle}</b><br>üìÖ ${e.date} üïí ${e.time}<br>üìç ${e.venue}<br>Seat: ${e.seat}<br>ID: ${e.ticketId}`,document.getElementById("modal").style.display="flex"}
function showIdCard(){if(!currentUser)return;const e="https://static.vecteezy.com/system/resources/previews/024/183/525/original/avatar-of-a-man-portrait-of-a-young-guy-illustration-of-male-character-in-modern-color-style-vector.jpg",t="https://static.vecteezy.com/system/resources/previews/024/183/500/original/female-avatar-brunette-woman-portrait-illustration-of-a-female-character-in-a-modern-color-style-vector.jpg";let n="https://i.imgur.com/KBOhEwI.png";if(currentUser.gender&&currentUser.gender.toLowerCase()==="male")n=e;else if(currentUser.gender&&currentUser.gender.toLowerCase()==="female")n=t;const a=document.getElementById("modal-body");let d = `<div class="id-card"><div class="id-card-header"><h3>${currentUser.role} ID CARD</h3></div><img src="${n}" alt="Avatar" class="id-card-avatar"><div class="id-card-details">`;
 d += `<p><strong>Name:</strong> ${capitalizeWords(currentUser.name||'')} ${capitalizeWords(currentUser.surname||'')}</p>`;
 d += `<p><strong>Reg. No:</strong> ${currentUser.regNumber||''}</p>`;
 if(currentUser.department) d += `<p><strong>Department:</strong> ${currentUser.department}</p>`;
 if(currentUser.branch) d += `<p><strong>Branch:</strong> ${currentUser.branch}</p>`;
 if(currentUser.bloodGroup) d += `<p><strong>Blood Group:</strong> ${currentUser.bloodGroup}</p>`;
 if(currentUser.address) d += `<p><strong>Address:</strong> ${currentUser.address}</p>`;
 if(currentUser.pincode) d += `<p><strong>Pincode:</strong> ${currentUser.pincode}</p>`;
 d += `</div></div>`;
 a.innerHTML = d,document.getElementById("modal").style.display="flex"}
function showEventIdCard(e){const t="https://static.vecteezy.com/system/resources/previews/024/183/525/original/avatar-of-a-man-portrait-of-a-young-guy-illustration-of-male-character-in-modern-color-style-vector.jpg",n="https://static.vecteezy.com/system/resources/previews/024/183/500/original/female-avatar-brunette-woman-portrait-illustration-of-a-female-character-in-a-modern-color-style-vector.jpg";let a="https://i.imgur.com/KBOhEwI.png";if(e.creatorGender&&e.creatorGender.toLowerCase()==="male")a=t;else if(e.creatorGender&&e.creatorGender.toLowerCase()==="female")a=n;const i=document.getElementById("modal-body");i.innerHTML=`<div class="id-card"><div class="id-card-header"><h3>EVENT ID CARD</h3></div><img src="${a}" alt="Organizer Avatar" class="id-card-avatar"><div class="id-card-details"><p style="font-size: 1.2rem"><strong>${capitalizeWords(e.title)}</strong></p><p><strong>Cat:</strong> ${e.category}</p><p><strong>Location:</strong> ${capitalizeWords(e.venue)}</p><p><strong>Organizer:</strong> ${capitalizeWords(e.creatorName)}</p></div></div>`,document.getElementById("modal").style.display="flex"}
function showLightbox(e,t){
    const modal = document.getElementById("lightbox-modal");
    const content = document.getElementById("lightbox-content");
    const fullUrl = `http://localhost:5000${e}`;
    const isOrganizer = currentUser && currentUser.role === 'ORGANIZER';
    let mediaHtml = '';
    if (t === 'photo') mediaHtml = `<img src="${fullUrl}">`;
    if (t === 'video') mediaHtml = `<video src="${fullUrl}" controls autoplay></video>`;
    const header = `<a class="lightbox-back-arrow" onclick="closeLightbox(event)">‚Üê</a>`;
    const downloadBar = isOrganizer ? `<div style="text-align:center; margin-top:12px;"><a href="${fullUrl}" download class="btn" style="display:inline-block; width:auto">‚¨á Download</a></div>` : '';
    content.innerHTML = header + mediaHtml + downloadBar;
    modal.style.display = "flex";
}

function downloadMedia(url){
    const a = document.createElement('a');
    a.href = `http://localhost:5000${url}`;
    a.download = '';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
function closeLightbox(e){ if(e) e.stopPropagation(); const modal = document.getElementById("lightbox-modal"); modal.style.display = "none"; modal.querySelector("#lightbox-content").innerHTML = ""; }
async function showMapModal(venue) {
    // Proactive cleanup to ensure fresh init without page reload
    try { if (watchId && navigator.geolocation) { navigator.geolocation.clearWatch(watchId); } } catch {}
    watchId = null;
    try { if (userMarker) userMarker.setMap(null); } catch {}
    try { if (venueMarker) venueMarker.setMap(null); } catch {}
    userMarker = null; venueMarker = null; gmap = null; directionsService = null; directionsRenderer = null;
    lastVenueLatLng = null; lastVenueName = '';

    const mapContainer = document.getElementById("map-container");
    document.getElementById("map-modal").style.display = "flex";
    mapContainer.innerHTML = `<div style="display:flex;flex-direction:column;width:100%;height:100%">
        <div style="padding: 12px 16px 12px 80px; background:#2a2a2a; border-bottom:1px solid #333; display:flex; align-items:center; justify-content:center; position:relative; z-index:2; text-align:center;">
            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%">
                <div style="font-weight:bold; color:#7c3aed; font-size:1.05rem;">üìç ${venue}</div>
                <div class="muted" style="font-size:0.9rem; color:#a1a1aa;">NITK Surathkal</div>
            </div>
        </div>
        <div id="gmaps" style="flex:1"></div>
        <div style="padding:10px; background:#2a2a2a; border-top:1px solid #333; display:flex; gap:10px">
            <button class="btn" style="flex:1" onclick="openExternalNavFromMap()">üó∫Ô∏è Get Directions</button>
        </div>
    </div>`;
    try {
        await ensureGoogleMapsLoaded();
        const target = await resolveVenueLatLng(venue);
        initLiveMap(target, venue);
        // Show a subtle banner if not secure context (affects geolocation precision on other machines)
        const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const isSecure = location.protocol === 'https:' || isLocalhost;
        if (!isSecure) {
            const header = mapContainer.querySelector('div > div');
            if (header) {
                const note = document.createElement('div');
                note.className = 'muted';
                note.style.cssText = 'position:absolute; right:16px; bottom:-18px; font-size:0.75rem; color:#a1a1aa;';
                note.textContent = 'Tip: For precise location, open via https or localhost';
                header.appendChild(note);
            }
        }
    } catch (err) {
        // Default to MAIN BUILDING if target isn't available
        const fallbackTarget = {lat:13.011118667256149,lng:74.7944203377819};
        showIframeFallback(venue, fallbackTarget);
    }
}

function ensureGoogleMapsLoaded(){
    return new Promise((resolve, reject) => {
        if (window.google && window.google.maps) return resolve();
        const scriptId = 'gmaps-script';
        if (document.getElementById(scriptId)) { const check = setInterval(()=>{ if(window.google&&window.google.maps){ clearInterval(check); resolve(); } },100); setTimeout(()=>{clearInterval(check); if(!(window.google&&window.google.maps)) reject(new Error('maps-timeout'));}, 5000); return; }
        const s = document.createElement('script');
        s.id = scriptId; s.async = true; s.defer = true; s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&v=weekly&libraries=places`;
        s.onload = () => resolve(); s.onerror = reject; document.head.appendChild(s);
    });
}

let gmap = null, userMarker = null, venueMarker = null, watchId = null, directionsService = null, directionsRenderer = null, lastVenueLatLng = null, lastVenueName = '', lastUserLatLng = null;
function initLiveMap(targetLatLng, venueName){
    // Clean up any previous state before initializing
    try { if (watchId && navigator.geolocation) { navigator.geolocation.clearWatch(watchId); } } catch {}
    watchId = null;
    try { if (userMarker) userMarker.setMap(null); } catch {}
    try { if (venueMarker) venueMarker.setMap(null); } catch {}
    userMarker = null; venueMarker = null;

    lastVenueLatLng = targetLatLng; lastVenueName = venueName;
    gmap = new google.maps.Map(document.getElementById('gmaps'), { center: targetLatLng, zoom: 16, disableDefaultUI: true, styles: [] });
    venueMarker = new google.maps.Marker({ position: targetLatLng, map: gmap, label: {text: 'üìç', color: '#ef4444'}, title: venueName });
    // If we have last known user position, show it immediately
    if (lastUserLatLng) {
        try {
            userMarker = new google.maps.Marker({ position: lastUserLatLng, map: gmap, title: 'You', zIndex: 9999, label: { text: 'üßç', color: '#10b981' } });
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(new google.maps.LatLng(targetLatLng.lat, targetLatLng.lng));
            bounds.extend(new google.maps.LatLng(lastUserLatLng.lat, lastUserLatLng.lng));
            gmap.fitBounds(bounds);
        } catch {}
    }
    // Ensure map lays out correctly after modal open
    try { setTimeout(() => { if (gmap) { google.maps.event.trigger(gmap, 'resize'); gmap.setCenter(targetLatLng); } }, 50); } catch {}
    directionsService = null; directionsRenderer = null; // removed live route rendering
    if (navigator.geolocation) {
        // Place an initial user marker as soon as we have a position
        try {
            navigator.geolocation.getCurrentPosition(pos => {
                const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                lastUserLatLng = p;
                if (!userMarker) {
                    userMarker = new google.maps.Marker({ position: p, map: gmap, title: 'You', zIndex: 9999, label: { text: 'üßç', color: '#10b981' } });
                } else {
                    userMarker.setPosition(p);
                    userMarker.setVisible(true);
                }
                // Fit bounds so both user and venue are visible
                try {
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(new google.maps.LatLng(targetLatLng.lat, targetLatLng.lng));
                    bounds.extend(new google.maps.LatLng(p.lat, p.lng));
                    gmap.fitBounds(bounds);
                } catch {}
            }, () => {}, { enableHighAccuracy: true, timeout: 10000, maximumAge: 15000 });
        } catch {}
        watchId = navigator.geolocation.watchPosition(pos => {
            const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            lastUserLatLng = p;
            if (!userMarker) userMarker = new google.maps.Marker({ position: p, map: gmap, title: 'You', zIndex: 9999, label: {text:'üßç', color:'#10b981'} }); else { userMarker.setPosition(p); userMarker.setVisible(true); }
            // Fit bounds so both user and venue are visible
            try {
                const bounds = new google.maps.LatLngBounds();
                const v = new google.maps.LatLng(targetLatLng.lat, targetLatLng.lng);
                const u = new google.maps.LatLng(p.lat, p.lng);
                bounds.extend(v); bounds.extend(u);
                gmap.fitBounds(bounds);
            } catch {}
        }, err => {}, { enableHighAccuracy: true, timeout: 15000, maximumAge: 15000 });
    }
}

function recenterMap(){ if (gmap && userMarker) gmap.panTo(userMarker.getPosition()); }
// live route removed; we only show user + venue markers
function routeToVenue(){ /* removed */ }
let activePolyline = null;
function toLatLngLiteral(p){ if (!p) return null; if (typeof p.lat === 'function') { return { lat: p.lat(), lng: p.lng() }; } if ('lat' in p && 'lng' in p) return p; return null; }
function drawPolylineRoute(){ /* removed */ }

// computeETAs removed per request
function openExternalNavFromMap(){ if (!lastVenueLatLng) return; const {lat,lng} = lastVenueLatLng; const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`; window.location.href = url; }

function showIframeFallback(venue, target){
    const mapContainer = document.getElementById('gmaps');
    const {lat,lng} = target;
    mapContainer.innerHTML = `<iframe src="https://www.google.com/maps?q=${lat},${lng}&z=16&output=embed" style="width:100%;height:100%;border:0"></iframe>`;
    const eta = document.getElementById('eta'); if (eta) eta.textContent = '';
}

// Resolve venue to precise coordinates using dictionary then Google Geocoder for higher precision
async function resolveVenueLatLng(venue){
    const dict = {
        'LH-C': {lat:13.00898,lng:74.79397}, 'LH-D': {lat:13.00970,lng:74.79346},
        'LH-A': {lat:13.00949,lng:74.79397}, 'LHB (MB)': {lat:13.01112,lng:74.79442},
        'SJA': {lat:13.00939,lng:74.79506}, 'MAIN BUILDING': {lat:13.01112,lng:74.79442},
        'SEMINAR HALL A (MB)': {lat:13.01113,lng:74.79428}, 'SEMINAR HALL B (MB)': {lat:13.01113,lng:74.79428},
        'SEMINAR HALL C (MB)': {lat:13.01113,lng:74.79428}, 'OPEN THEATER': {lat:13.01083,lng:74.79695},
        'NEW SPORTS COMPLEX': {lat:13.01006,lng:74.79830}, 'MAIN GROUND': {lat:13.01015,lng:74.79755},
        'NITK BEACH': {lat:13.00981,lng:74.78811}, 'CRF': {lat:13.00933,lng:74.79539}, 'GYM': {lat:13.00720,lng:74.79482}
    };
    if (dict[venue]) return dict[venue];
    if (!(window.google && google.maps)) return {lat:13.01112,lng:74.79442};
    return new Promise((resolve) => {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: `${venue}, NITK Surathkal, Karnataka` }, (results, status) => {
            if (status === 'OK' && results && results[0]) {
                const ll = results[0].geometry.location;
                resolve({ lat: ll.lat(), lng: ll.lng() });
            } else {
                resolve({lat:13.01112,lng:74.79442});
            }
        });
    });
}

// Catch Google Maps auth errors (e.g., RefererNotAllowedMapError) and degrade gracefully to iframe
window.gm_authFailure = function(){
    if (lastVenueLatLng) {
        showIframeFallback(lastVenueName || 'Venue', lastVenueLatLng);
    }
};
function closeMap() {
    // Stop geolocation and clear markers/state so reopening works without refresh
    try { if (watchId && navigator.geolocation) { navigator.geolocation.clearWatch(watchId); } } catch {}
    watchId = null;
    try { if (userMarker) userMarker.setMap(null); } catch {}
    try { if (venueMarker) venueMarker.setMap(null); } catch {}
    userMarker = null; venueMarker = null; gmap = null; directionsService = null; directionsRenderer = null;
    // Preserve lastUserLatLng so we can show immediately on next open
    lastVenueLatLng = null; lastVenueName = '';
    document.getElementById("map-modal").style.display = "none";
    document.getElementById("map-container").innerHTML = "";
}
function showDirections(venue, coordinates) {
    // Get user's current location and open directions in Google Maps
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
        const { latitude, longitude } = position.coords;
        const origin = `${latitude},${longitude}`;
                
                // Open Google Maps directions with user's location
                const directionsUrl = `https://www.google.com/maps/dir/${origin}/${coordinates}/@${coordinates},18z/data=!3m1!1e3`;
                window.location.href = directionsUrl;
            },
            (error) => {
                // Fallback: Open directions without user location
                console.log('Geolocation error:', error);
                const destinationName = encodeURIComponent(`${venue}, NITK Surathkal`);
                const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationName}`;
                window.location.href = directionsUrl;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    } else {
        // Fallback if geolocation is not supported
        const destinationName = encodeURIComponent(`${venue}, NITK Surathkal`);
        const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destinationName}`;
        window.location.href = directionsUrl;
    }
}

function openInGoogleMaps(venue, coordinates) {
    // Open Google Maps with the venue location
    const mapUrl = `https://www.google.com/maps/@${coordinates},18z/data=!3m1!1e3`;
    window.location.href = mapUrl;
}

function getDirections(venue, coordinates) {
    // Alias for showDirections
    showDirections(venue, coordinates);
}
function refreshEvents(){document.getElementById("screen-home").innerHTML='<p class="muted">üîÑ Refreshing...</p>',setTimeout(renderEvents,1e3)}
async function refreshTickets(){document.getElementById("screen-tickets").innerHTML='<p class="muted">üîÑ Refreshing...</p>',await renderTickets(!0),setTimeout(renderTickets,1e3)}
function capitalizeWords(str) { if (!str) return ''; return str.replace(/\b\w/g, char => char.toUpperCase()); }
function startCountdownTimers() {
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
        document.querySelectorAll('[id^="countdown-"]').forEach(el => {
            const startTime = new Date(el.dataset.startTime);
            const now = new Date();
            const diff = startTime - now;
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                if (days > 0) {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${days}d ${String(hours).padStart(2,'0')}h ${String(minutes).padStart(2,'0')}m</strong>`;
                } else if (hours > 0) {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${String(hours).padStart(2,'0')}h ${String(minutes).padStart(2,'0')}m</strong>`;
                } else if (minutes > 0) {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${String(minutes).padStart(2,'0')}m ${String(seconds).padStart(2,'0')}s</strong>`;
                } else {
                    el.innerHTML = `‚è± <strong style="color:#ff0000; font-weight: bold;">Starts in ${String(seconds).padStart(2,'0')}s</strong>`;
                }
            } else {
                el.innerHTML = `<strong style="color:#ff0000; font-weight: bold;">üî• LIVE NOW</strong>`;
            }
        });
    }, 1000);
}

// Test function for notifications (can be called from browser console)
function testNotifications() {
    console.log("Testing notifications...");
    checkEventStartNotifications();
}

// Utility to show a temporary welcome banner using the existing ticker area (non-scrolling)
function showWelcomeBanner(message){
    const bar = document.getElementById('notificationTicker');
    const text = document.getElementById('notificationTickerText');
    if(!bar || !text) return;
    text.textContent = message;
    text.style.animationPlayState = 'paused';
    text.style.transform = 'translateX(0)';
    text.style.paddingLeft = '0';
    bar.style.display = 'block';
    welcomeBannerUntil = Date.now() + 2500;
    setTimeout(()=>{
        const screenNotifVisible = document.getElementById('screen-notifications').style.display === 'block';
        if(!screenNotifVisible){ bar.style.display = 'none'; }
    }, 2500);
}

// Initialize app - check for saved login or show auth
checkSavedLogin();
</script>
</body>
</html>